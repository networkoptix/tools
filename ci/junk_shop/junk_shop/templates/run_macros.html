
{% macro run_box(node, box_class='', expand_level=0) %}

  <div class="{{ box_class }}">
    <div>

      <a class="run-name
                {%- if node.run.outcome %} outcome outcome-{{ node.run.outcome }}{% endif -%}
                {%- if node.has_children %} run-expandable
                    {%- if expand_level <= 0 %} run-collapsed{% else %} run-expanded{% endif %}
                    {%- if node.lazy %} run-lazy-children-loading {%- endif -%}
                {%- else %}
                  outcome-leaf
                {%- endif %}"
                {% if node.has_children %}
                  href="#" onclick="return toggle_children_visible(
                      this, {{ node.run.id }}, '{{ url_for('run_children', run_id=node.run.id) }}')"
                {% endif %}
                >
        {% if node.run.name %}
          {{ node.run.name }}
        {% else %}
          {{ node.run.path }}
        {% endif %}
      </a>

      <span class="run-property">{{ node.run.started_at|format_datetime|default('-', true) }}</span>
      {% if node.run.duration is not none %}<span class="run-property">Duration: {{ node.run.duration|format_timedelta }}</span>{% endif %}

      {% if node.artifacts %}
        <span class="artifacts-pane">
          {% for artifact in node.artifacts %}
            <a id="{{ artifact.id }}"
               {% if artifact.is_binary %}
                 href="{{ url_for('get_artifact', artifact_id=artifact.id) }}"
               {% else %}
                 href="#"
               {% endif %}
               class="artifact-button {% if artifact.is_error %}artifact-button-error{% endif %}
                      {%- if artifact.is_binary %} artifact-button-binary {%- else %} artifact-button-text {%- endif %}"
               {% if not artifact.is_binary %}
                 onclick="return toggle_artifact_visible(this, {{ artifact.id }}, '{{ artifact.name }}', '{{ url_for('get_artifact', artifact_id=artifact.id) }}')"
               {% endif %}
               >
              {{ artifact.name }}
            </a>
          {% endfor %}
        </span>
      {% endif %}

      {% if node.run.root_run is none %}
        <a href="{{ url_for('run', run_id=node.run.id) }}" class="permalink">&para;</a>
      {% endif %}

    </div>

    <div class="ajax-loading-error" style="display: none"></div>
    <div class="artifacts" style="display: none"></div>

    <ul style="{% if expand_level <= 0 -%} display: none {%- endif %}">
      {{ run_box_children(node.children, expand_level=expand_level - 1) }}
    </ul>

  </div>

{% endmacro %}


{% macro run_box_children(node_list, box_class, expand_level=0) %}

  {% for node in node_list %}
    <li id="{{ node.run.id }}" class="run">
      {{ run_box(node, box_class, expand_level) }}
    </li>
  {% endfor %}

{% endmacro %}

{% macro run_link(name, rec) %}

  <div class="tests-block">
    <a {% if rec.run -%} href="{{ url_for('run', run_id=rec.run.id) }}" {%- endif %}
       class="outcome outcome-{{ rec.run.outcome if rec.run else 'not-run' }} {% if rec.run -%} has-run {%- endif %}">
       {{ name }}
    </a>
    <div class="test-counts">
      {% if rec.run %}
        <span class="passed">
          {%- if rec.test_count.passed -%}
            {{ rec.test_count.passed }}
          {%- else -%}
            0
          {%- endif -%}
        </span>&nbsp/&nbsp<span class="failed">
          {%- if rec.test_count.failed -%}
            {{ rec.test_count.failed }}
          {%- else -%}
            0
          {%- endif -%}
        </span>
      {% else %}
        <span>&nbsp</span>
      {% endif %}
    </div>
  </div>

{% endmacro %}

{% macro header(branch_name, platform_name, version_name) %}

  <a class="link" href="{{ url_for('branch_list') }}">Branches</a>
  {%- if branch_name -%}
    {%- if platform_name -%}
      &nbsp/&nbsp
      <a class="link"
         href="{{ url_for('branch_platform_list', branch_name=branch_name) }}">
        {{ branch_name }}
      </a>
      {%- if version_name -%}
        &nbsp/&nbsp
        <a class="link"
           href="{{ url_for('branch_version_list', branch_name=branch_name, platform_name=platform_name) }}">
          {{ platform_name }}
        </a>
        <h2>{{ version_name }}</h2>
      {%- else -%}
         <h2>{{ platform_name }}</h2>
       {%- endif -%}
    {%- else -%}
      <h2>{{ branch_name }}</h2>
    {%- endif -%}
 {%- else -%}
    {%- if platform_name -%}
      <h2>{{ platform_name }}</h2>
    {%- endif -%}
  {%- endif -%}

{% endmacro %}
