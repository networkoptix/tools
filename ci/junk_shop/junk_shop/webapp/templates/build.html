{% import "common_macros.html" as common_macros %}

{% extends "layout.html" %}
{% block title -%} {{ project_name }} / {{ branch_name }} / {{ build.version }} {%- endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='build.css') }}">
{% endblock head %}


{% block contents %}

    {{ common_macros.breadcrumbs([
      ('Projects',  url_for('project_list')),
      (project_name + ' / ' + branch_name, url_for('branch', project_name=project_name, branch_name=branch_name)),
    ]) }}

    <h2>{{ build.version }}</h2>
    <hr>

    <div class="build-info">
      <div>
        <div class="title">Started at</div>
        <div class="markup-value">{{ started_at|format_datetime }}</div>
      </div>
      {% if build.version %}
        <div>
          <div class="title">Version</div>
          <div class="value">{{ build.version }}</div>
        </div>
      {% endif %}
      {% if build.revision %}
        <div>
          <div class="title">Revision</div>
          <div class="value">{{ repository }} #{{ build.revision|decorate_revision(build.repository_url) }}</div>
        </div>
      {% endif %}
      {% if build.is_incremental is not none %}
        <div>
          <div class="title">Build</div>
          <div class="value"> {%- if build.is_incremental -%} Incremental {%- else -%} Full {%- endif -%} </div>
        </div>
      {% endif %}
      {% if build.jenkins_url %}
        <div>
          <div class="title">Jenkins page</div>
          <div class="value">
            <a href="{{ build.jenkins_url }}">Build #{{ jenkins_build_num }}</a>
          </div>
        </div>
      {% endif %}
      {% if build.cloud_group %}
        <div>
          <div class="title">Cloud group</div>
          <div class="value">{{ build.cloud_group.name }}</div>
        </div>
      {% endif %}
      {% if build.configuration %}
        <div>
          <div class="title">Configuration</div>
          <div class="value">{{ build.configuration }}</div>
        </div>
      {% endif %}
      {% if build.customization %}
        <div>
          <div class="title">Customization</div>
          <div class="value">{{ build.customization.name }}</div>
        </div>
      {% endif %}
    </div>

    {% if changeset_list %}
      <div class="commit-block block">
        <h3>Commits</h3>
        {{ common_macros.changeset_list(changeset_list) }}
      </div>
    {% endif %}

    {% for platform in platform_list %}
      {% if tests_run_map.has_key(platform) or platform_to_build_output.has_key(platform) %}
        <h2 class="platform-name">
          {%- if platform_to_build_output.has_key(platform) -%}
            <a class="link" href="{{ url_for('artifact', artifact_id=platform_to_build_output[platform]) }}">
            {{- platform.name -}}
            </a>
          {%- else -%}
            {{- platform.name -}}
          {%- endif -%}
        </h2>
        <hr>
        <div class="platform-build-blocks">
          {% if platform in failed_builds %}
            <div class="build-block block">
              <h3>
                <a class="link" href="{{ url_for('artifact', artifact_id=platform_to_build_output[platform]) }}">
                  Build errors
                </a>
              </h3>
              <div class="build-errors">
                {% for line in failed_builds[platform] %}
                  {{- line -}} <br/>
                {% endfor %}
              </div>
            </div>
          {% endif %}
          {% for root_run, tests_run in tests_run_map.get(platform, {})|dictsort %}
            <div class="build-block block">
              <h3>
                <a class="link" href="{{ url_for('run', run_id=root_run.id) }}">
                {%- if tests_run.stage == 'unit' -%}
                  Unit&nbsp;Tests
                {%- elif tests_run.stage == 'functional' -%}
                  Functional&nbsp;Tests
                {%- endif -%}
                </a>
              </h3>
              {% if (platform, root_run) in error_map %}
                <div class="run-errors">
                  {% for error in error_map[(platform, root_run)] %}
                    {{ error }}<br/>
                  {% endfor %}
                </div>
              {% endif %}
              <div class="test-counts">
                <span class="passed">{{ tests_run.passed_count }}</span>
                {% if tests_run.failed_count %}
                  / <span class="failed">{{ tests_run.failed_count }}</span>
                {% endif %}
              </div>
              {% if tests_run.run_list %}
                <table class="test-list">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Status</th>
                      <th></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for run in tests_run.run_list %}
                      <tr>
                        <td>
                          <a class="test-link" href="{{ url_for('run', run_id=root_run.id, _anchor=run.run.id) }}">
                            {{ run.test_name }}
                          </a>
                        </td>
                        <td class="outcome {% if run.succeeded -%} passed {%- else -%} failed {%- endif %}">
                          {{- run.status -}}
                        </td>
                        <td class="error-message">{{ run.run.error_message }}</td>
                        <td class="output-link">
                          {% if run.output_artifact_id %}
                            <a class="link" href="{{ url_for('artifact', artifact_id=run.output_artifact_id) }}">
                              Output
                            </a>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}

{% endblock contents %}
