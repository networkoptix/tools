# -*- sh -*-

set -o errexit +o nounset -o noclobber
ARGS="$TASKBOT_OPTIONS $TASKBOT_CONFIG"

set -o errexit +o nounset -o noclobber
ARGS="$TASKBOT_OPTIONS $TASKBOT_CONFIG"

CURRENT_CONFIG="$TASKBOT_VAR"/nx_vms/build_variables/target/current_config

# + Prepare test environment
QT_DIR=$(grep qt_dir= "$CURRENT_CONFIG" | sed -r 's/qt_dir=//')

echo $QT_DIR

if [ -n "$QT_DIR" ]; then
  QT_CYGWIN_PATH=$(cygpath "$QT_DIR")
  export PATH=$PATH:$QT_CYGWIN_PATH/bin
fi

echo $PATH

UNIT_TESTS_RESULT_PATH="$TASKBOT_VAR"/var/utests

if [ ! -d "$UNIT_TESTS_RESULT_PATH" ]; then 
  mkdir -p "$UNIT_TESTS_RESULT_PATH"
else
  rm -rf "$UNIT_TESTS_RESULT_PATH"/*
fi

NX_VMS_BIN_PATH=$(grep bin_dir= "$CURRENT_CONFIG" | sed -r 's/bin_dir="?([^"]+)"?/\1/')
cd $NX_VMS_BIN_PATH

TEST_LIST=$TASKBOT_UNIT_TESTS
if [ $TASKBOT_UNIT_TESTS = "all" ]; then
  TEST_LIST=$(find . -name '*_ut.exe' -type f -exec basename -s .exe {} \;)
fi

# + Run tests
for name in $TEST_LIST
do
  test_tmp=$UNIT_TESTS_RESULT_PATH/$name
  mkdir -p $test_tmp
  test_win_tmp=$(cygpath -w "$test_tmp")
  test=$name.exe
  "$TASKBOT" $TASKBOT_OPTIONS $TASKBOT_CONFIG \
      -d "$name"  \
      -c "nice -n -20 ./$test --gtest_filter=-NxCritical.All3 --tmp=\"$test_win_tmp\" --gtest_catch_exceptions=0 --gtest_shuffle --log-file=$UNIT_TESTS_RESULT_PATH/$name  --log-level=DEBUG2" \
      -e "procdump $test" \
      -t 900 -s 100 || true
  find "$LOCALAPPDATA" -name "*$name*.dmp" -exec mv '{}' $test_tmp \;
  find . -name "*$name*.dmp" -exec mv '{}' $test_tmp \;
done

# + Process core files
"$TASKBOT" $ARGS "$TASKBOT_SHARE"/process_cores.taskbot

# + Store test results
$TASKBOT_BIN/file.py \
     $TASKBOT_CONFIG \
    --path $UNIT_TESTS_RESULT_PATH \
    --mask '*.log'
