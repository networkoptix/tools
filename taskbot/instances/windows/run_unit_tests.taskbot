# -*- sh -*-

set -o errexit +o nounset -o noclobber
ARGS="$TASKBOT_OPTIONS $TASKBOT_CONFIG"

set -o errexit +o nounset -o noclobber
ARGS="$TASKBOT_OPTIONS $TASKBOT_CONFIG"

# + Prepare test environment
QT_LIBS=`find "$TASKBOT_DEVELOP_PATH"/buildenv_admin/packages -name 'Qt5*.dll' -print | head -n 1`
if [ -n "$QT_SERVER_LIB" ]; then
  QT_LIB_PATH=$(dirname "$QT_LIB")
  export PATH=$PATH:$QT_LIB_PATH
fi

UNIT_TESTS_RESULT_PATH="$TASKBOT_VAR"/var/utests

if [ ! -d "$UNIT_TESTS_RESULT_PATH" ]; then 
  mkdir -p "$UNIT_TESTS_RESULT_PATH"
else
  rm -rf "$UNIT_TESTS_RESULT_PATH"/*
fi

# + Run tests
cd "$TASKBOT_VAR"/nx_vms/build_environment/target/bin/release
for test in $(find . -name 'common_ut' -type f)
do
  name=$(basename $test)
  "$TASKBOT" -d $name $TASKBOT_OPTIONS $TASKBOT_CONFIG \
     -c "$test  --gtest_output=xml:$UNIT_TESTS_RESULT_PATH/$name.xml" || true
done

# + Store results
for xml in $(find "$UNIT_TESTS_RESULT_PATH" -name '*.xml' -type f)
do
 filename=$(basename $xml)
 name=${filename%.*}
 "$TASKBOT" -d $name $TASKBOT_OPTIONS $TASKBOT_CONFIG \
   -c "cat $xml" --trace
done
