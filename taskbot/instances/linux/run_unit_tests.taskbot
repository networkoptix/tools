# -*- sh -*-

set -o errexit +o nounset -o noclobber
ARGS="$TASKBOT_OPTIONS $TASKBOT_CONFIG"

# + Prepare test environment

CURRENT_CONFIG="$TASKBOT_VAR"/nx_vms/build_variables/target/current_config

QT_DIR=$(grep qt_dir= "$CURRENT_CONFIG" | sed -r 's/qt_dir=//')
QT_LIB=`find "$QT_DIR" -name 'libQt*.so' -print | head -n 1`
if [ -n "$QT_LIB" ]; then
  QT_LIB_PATH=$(dirname "$QT_LIB")
  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$QT_LIB_PATH
fi

NX_VMS_LIB_PATH=$(grep linux_lib_dir= "$CURRENT_CONFIG" | sed -r 's/linux_lib_dir=//')
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$NX_VMS_LIB_PATH

echo $LD_LIBRARY_PATH

UNIT_TESTS_RESULT_PATH="$TASKBOT_VAR"/var/utests

if [ ! -d "$UNIT_TESTS_RESULT_PATH" ]; then 
  mkdir -p "$UNIT_TESTS_RESULT_PATH"
else
  rm -rf "$UNIT_TESTS_RESULT_PATH"/*
fi

NX_VMS_BIN_PATH=$(grep bin_dir= "$CURRENT_CONFIG" | sed -r 's/bin_dir="?([^"]+)"?/\1/')
cd $NX_VMS_BIN_PATH

TEST_LIST=$TASKBOT_UNIT_TESTS
if [ $TASKBOT_UNIT_TESTS = "all" ]; then
  TEST_LIST=$(find . -name '*_ut' -type f -exec basename {} \;)
fi
echo $TEST_LIST

# + Run tests
for test in $TEST_LIST
do
  "$TASKBOT" \
     -d $test $TASKBOT_OPTIONS $TASKBOT_CONFIG \
     -c "./$test --gtest_output=xml:$UNIT_TESTS_RESULT_PATH/$name.xml --gtest_filter=-NxCritical.All3" \
     -t 600 -s 100 || true
done

# + Store results
for xml in $(find "$UNIT_TESTS_RESULT_PATH" -name '*.xml' -type f)
do
 filename=$(basename $xml)
 name=${filename%.*}
 "$TASKBOT" -d $name $TASKBOT_OPTIONS $TASKBOT_CONFIG \
   -c "cat $xml" --trace
done

# + Process core files
"$TASKBOT" $ARGS "$TASKBOT_SHARE"/process_cores.taskbot
