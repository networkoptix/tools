# -*- sh -*-

set -o errexit +o nounset -o noclobber
ARGS="$TASKBOT_OPTIONS $TASKBOT_CONFIG"

# + Prepare environment
CURRENT_CONFIG="$TASKBOT_VAR"/nx_vms/build_variables/target/current_config

QT_DIR=$(grep qt_dir= "$CURRENT_CONFIG" | sed -r 's/qt_dir=//')
QT_LIB=`find "$QT_DIR" -name 'libQt*.so' -print | head -n 1`
if [ -n "$QT_LIB" ]; then
  QT_LIB_PATH=$(dirname "$QT_LIB")
fi

NX_VMS_LIB_PATH=$(grep linux_lib_dir= "$CURRENT_CONFIG" | sed -r 's/linux_lib_dir=//')

NX_VMS_BIN_PATH=$(grep bin_dir= "$CURRENT_CONFIG" | sed -r 's/bin_dir="?([^"]+)"?/\1/')

cd $NX_VMS_BIN_PATH
TEST_LIST=$TASKBOT_UNIT_TESTS
if [ "$TASKBOT_UNIT_TESTS" = "all" ]; then
  TEST_LIST=$(find . -name '*_ut' -type f -exec basename {} \;)
fi
echo $TEST_LIST

# + Copy binary files
NX_WORK_DIR=/home/test/taskbot/$TASKBOT_BRANCHNAME
NX_VMS_BIN_DST_PATH="$NX_WORK_DIR/nx_vms/bin"
NX_VMS_LIB_DST_PATH="$NX_WORK_DIR/nx_vms/lib"

CMD=$(cat << EOF
[ -d $NX_WORK_DIR ] && rm -rvf $NX_WORK_DIR
mkdir -p $NX_VMS_BIN_DST_PATH
mkdir -p $NX_VMS_LIB_DST_PATH
EOF
)
ssh -tt test@$TASKBOT_NX1_ADDRESS "$CMD"

echo $QT_LIB_PATH
echo $NX_VMS_LIB_PATH
echo $NX_VMS_BIN_PATH

scp $QT_LIB_PATH/*.so* test@$TASKBOT_NX1_ADDRESS:$NX_VMS_LIB_DST_PATH
scp $NX_VMS_LIB_PATH/*.so* test@$TASKBOT_NX1_ADDRESS:$NX_VMS_LIB_DST_PATH
scp $NX_VMS_BIN_PATH/*_ut test@$TASKBOT_NX1_ADDRESS:$NX_VMS_BIN_DST_PATH
scp $TASKBOT_SHARE/run_unit_test.sh test@$TASKBOT_NX1_ADDRESS:$NX_VMS_BIN_DST_PATH

# + Remove results folder
ssh -tt test@$TASKBOT_NX1_ADDRESS "rm -rfv $NX_VMS_BIN_DST_PATH/../../var"

# + Run tests
for test in $TEST_LIST
do
    "$TASKBOT" $TASKBOT_OPTIONS $TASKBOT_CONFIG \
     -d "$test"  \
     -c "LANG=C ssh -tt test@$TASKBOT_NX1_ADDRESS \"export TERM=\\\"xterm -cm\\\"; cd $NX_VMS_BIN_DST_PATH && ./run_unit_test.sh $test\"" \
     -t 1000 -s 100 || true
done

# + Process core files
"$TASKBOT" $ARGS "$TASKBOT_SHARE"/process_cores.taskbot

# + Get test results
UNIT_TESTS_RESULT_PATH="$TASKBOT_VAR"/var/utests
mkdir -p "$UNIT_TESTS_RESULT_PATH"
scp -r test@$TASKBOT_NX1_ADDRESS:$NX_VMS_BIN_DST_PATH/../../var/* "$UNIT_TESTS_RESULT_PATH"

# + Store test results
$TASKBOT_BIN/file.py \
     $TASKBOT_CONFIG \
    --path $UNIT_TESTS_RESULT_PATH \
    --mask '*.log'
