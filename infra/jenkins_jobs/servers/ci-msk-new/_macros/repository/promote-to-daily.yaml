- builder:
    name: repository/promote-to-daily
    builders:
    - shell: !j2: |
        #!bash
        set -ex
        REPOSITORY_ROOT_PATH="{{ artifact_repository_base_path }}/$PIPELINE/$BRANCH/$BUILD_IDENTITY"
        _version_file="$(find "${REPOSITORY_ROOT_PATH}" -name build_info.txt | head -1)"
        _version="$(cat "${_version_file}" | grep version | tail -1 | cut -f 2 -d '=')"
        TARGET_ROOT="/mnt/beta-builds/daily/${BUILD_IDENTITY}-${BRANCH}"
        mkdir -p "${TARGET_ROOT}"
        echo "$_version" > "${TARGET_ROOT}/version"
        tree $REPOSITORY_ROOT_PATH
        customizations="$(ls "${REPOSITORY_ROOT_PATH}")"
        for customization in $customizations ; do
          mkdir -p "${TARGET_ROOT}/${customization}/"
          platforms="$(ls $REPOSITORY_ROOT_PATH/$customization | grep -v all)"
          for platform in $platforms ; do
            mkdir -p "${TARGET_ROOT}/${customization}/${platform}"
            if [ -d "${REPOSITORY_ROOT_PATH}/${customization}/${platform}/distrib/" ] ; then
              pushd "${REPOSITORY_ROOT_PATH}/${customization}/${platform}/distrib/"
                files="$(ls)"
              popd
              for file in $files ; do
                ln -f "${REPOSITORY_ROOT_PATH}/${customization}/${platform}/distrib/${file}" "${TARGET_ROOT}/${customization}/${platform}/${file}"
              done
            fi
          done
        done
        curl "http://depcon-test.hdw.mx/releases/registerBuild?buildDirectory=${BUILD_IDENTITY}-${BRANCH}"
