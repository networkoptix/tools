- builder:
    name: vms/clear-cmake-build
    builders:

    - shell: !j2: |
        #!bash
        set -x # set -e is is missing intentionally

        # Log file must not exist
        test ! -f "build_logs/cleaner.log"

        # Create bash script filled with args, unset too long envvars and
        # execute cleaner command
        # ----------------------------------------------------------------------
        cat > custom_clean.sh <<BUILDSCRIPT
        #!bash
        # set -xe is is missing intentionally
        SECONDS=0
        {% if __debug__ %}
        echo "Env is:"
        env
        {% endif %}

        cd "build"
        if [ ! -f "nx_vms/build_utils/python/clear_cmake_build.py" ] ; then
          echo "There is no custom cleaner"
          exit 0
        fi
        echo "Running custom cleaner"

        python "nx_vms/build_utils/python/clear_cmake_build.py" --build-dir "\${WORKSPACE}/build"
        ec=\$?
        echo "Took - \$SECONDS seconds"
        echo "Exit code - \$ec"
        exit "\$ec"
        BUILDSCRIPT
        # ----------------------------------------------------------------------
        cat custom_clean.sh
        bash custom_clean.sh 2>&1 | tee "build_logs/cleaner.log"
        # Abort if buildscript failed
        exit "${PIPESTATUS[0]}"
