# We sometimes have corrupted data in hg repo, which fail build very fast and
# drains build queue. To prevent next builds from failing on the same
# problem use these 2 macros.

# This builder should be executed as the very first step in build process
# So we set mark that hg operatins were sucessful.
# If build failed on hg, then this mark will not be set
- builder:
    name: mercurial/mark-successful-checkout
    builders:
    - shell: |
        #!bash
        touch ____successful_checkout.flag

# This publisher runs unconditionally after build done.
# From flag we know can differ build failed because of hg corrupted from builds
# which failed because of other reasons.
# So if marker is missing, then we must remove corrupted repo.
# We can't be sure on which one is corrupted, so remove all hg stuff.
- publisher:
    name: mercurial/rm-repo-if-broken
    publishers:
    - postbuildscript:
        mark-unstable-if-failed: true
        builders:
        - role: SLAVE
          build-on: [ SUCCESS, UNSTABLE, FAILURE, NOT_BUILT, ABORTED ]
          build-steps:
          - shell: |
              #!bash
              if [ ! -f ____successful_checkout.flag ] ; then
                # pre-scm or scm steps are failed => damaged hg repos
                if [ -d nx_vms ] ; then rm -rf ./nx_vms ; fi
                if [ -d devtools ] ; then rm -rf ./devtools ; fi
              else
                rm -f ____successful_checkout.flag
              fi
