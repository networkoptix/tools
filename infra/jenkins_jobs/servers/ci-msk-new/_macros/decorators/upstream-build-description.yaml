- builder:
    # Required parameters:
    #   envvars - envvars which description template requires
    #   target - upstream | current - which build to operate
    #   action - append | ? - append or replace description
    #   description - groovy fstring
    name: custom-build-description
    builders:
    - system-groovy:
        command: !j2: |
          // instance of hudson.model.FreeStyleBuild
          // https://javadoc.jenkins.io/hudson/model/FreeStyleBuild.html
          def currentBuild = Thread.currentThread().executable;

          // instance of hudson.EnvVars
          // https://javadoc.jenkins-ci.org/hudson/EnvVars.html
          def env = Thread.currentThread().executable.getEnvVars();

          {% for var in envvars %}
          def {{ var }} = env.get("{{ var }}");
          {% endfor %}

          def description = """{{ description }}""";

          {# set descriptionfor current build #}
          {% if target == "current" %}
          currentBuild.setDescription(description);
            {% if action == "append" %}
          currentBuild.setDescription(currentBuild.getDescription() + description);
            {% else %}
          currentBuild.setDescription(description);
            {% endif %}
          {% endif %}

          {# set description for upstream build #}
          {% if target == "upstream" %}
          def cause = currentBuild.getCause(hudson.model.Cause$UpstreamCause);
          def parentBuildNum = cause.upstreamBuild;
          def parentJobName = cause.upstreamProject;
          def parentJob = hudson.model.Hudson.instance.getItem(parentJobName);
          def parentBuild = parentJob.getBuildByNumber(parentBuildNum);
            {% if action == "append" %}
          parentBuild.setDescription(parentBuild.getDescription() + description);
            {% else %}
          parentBuild.setDescription(description);
            {% endif %}
          {% endif %}
