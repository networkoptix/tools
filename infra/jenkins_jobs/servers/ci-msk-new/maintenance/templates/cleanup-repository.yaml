
- job-template:
    name: cleanup-repository
    description: >
      Remove old artifacts from CINAS/beta-builds repository

    # required template parameters:
    # * node  - Node to run this job on.
    # * retain_days  - For how long keep artifacts in repository, days. Delete artifacts older than this.
    # * repository_dir - Root repository directory, mounted to *node*.
    # * watchers  - Who will receive email notifications.

    node: repository-ops

    parameters:
    - string:
        name: RETAIN_DAYS
        default: '{retain_days}'
        description: 'Remove artifacts older than this.'
    - on-off-option:
        name: DRY_RUN
        default: 'OFF'
        description: 'Do not remove, just show what would be removed.'

    triggers:
    - timed: 'H 21 * * *'

    wrappers:
    - timestamps

    builders:

    - shell: |
        #!/bin/bash
        set -ex

        # repository has format like this:
        # /mnt/beta-builds/repository/v1/develop/vms/3840
        # so we must look into 3rd level, from v1 to build number

        cd "{repository_dir}"

        if [[ $DRY_RUN == ON ]]; then
            find . -mindepth 3 -maxdepth 3 -type d -mtime "+$RETAIN_DAYS"
        else
            find . -mindepth 3 -maxdepth 3 -type d -mtime "+$RETAIN_DAYS" | xargs rm -rfv
        fi

    publishers:
    - email-ext:

        aborted:        true
        failure:        true
        still-failing:  true
        fixed:          true

        # ---- email contents ----
        send-to:
        - recipients
        - requester
        recipients: '{watchers}'
        subject: '[Jenkins] $BUILD_STATUS - Cleanup repository - # $BUILD_NUMBER'
        body: |
          Cleanup repository: $BUILD_STATUS

          $BUILD_LOG
        # ---- email contents ----
