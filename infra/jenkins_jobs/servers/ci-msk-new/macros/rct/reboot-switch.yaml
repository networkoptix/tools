- builder:
    name: reboot-switch
    builders:
    # Exec script to restart switch with cameras,
    # This is required to avoid hangs during/before/after tests
    # FIXME: Unhardcode passwords
    - shell: |
        #!/bin/bash
        set -ex

        if [ ! -d venv ]; then
          virtualenv venv
        fi

        source venv/bin/activate
        pip install --upgrade py-zabbix

        python - <<EOF

        from zabbix.api import ZabbixAPI

        URL = 'http://zabbix/'
        USER = 'jenkins'
        PASSWORD = 'P6bpGT8sxf'
        SERVER_NAME = "Zabbix server"
        SCRIPT_NAME = "HPE1_reboot"
        zapi_jenkins = ZabbixAPI(URL, user=USER, password=PASSWORD)

        print "INFO: Trying to restart cameras' switch"
        try:
            host_id = filter(
                lambda x: x['name'] == SERVER_NAME,
                zapi_jenkins.host.get()
            )[0]['hostid']
        except:
            print "ERROR: Problems with host id"
            raise

        try:
            script_id = filter(
                lambda x: x['name'] == SCRIPT_NAME,
                zapi_jenkins.script.get()
            )[0]['scriptid']
        except:
            print "ERROR: Problems with script id"
            raise
        try:
            zapi_jenkins.script.execute(
                hostid=host_id,
                scriptid=script_id
            )
        except:
            print "ERROR: Problems with script exec"
            raise

        print "INFO: Done"
        EOF
