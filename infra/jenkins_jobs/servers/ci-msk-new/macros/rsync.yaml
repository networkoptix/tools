- builder:
    name: rsync-upload
    builders:
    - shell: |
        #!/bin/bash
        set -ex

        RSYNC_HOST="{host}"
        RSYNC_PORT="{port}"
        RSYNC_USER="{user}"

        # components ~> "dir1/,dir2/,file1,file2"
        echo "Will rsync {components} components"

        IFS=, read -ra COMPONENTS_ARRAY <<< "{components}"
        for COMPONENT in "${{COMPONENTS_ARRAY[@]}}"
        do
          RSYNC_SRC="{src_path}/${{COMPONENT}}"
          RSYNC_DST="{dst_path}/${{COMPONENT}}"

          # When working with windows Jenkins node Workspace is represented as windows path.
          # Volume name ('C:') and back-slashes ('\') are error prone.
          # One of the option is to replace them with cygwin paths.

          # replace 'C:\' with '/cygdrive/c/'
          RSYNC_DST="${{RSYNC_DST/C:\\//cygdrive/c/}}"
          # replace every (//) backslash '\' (\\) with (/)  slash '/' (/)
          RSYNC_DST="${{RSYNC_DST//\\//}}"

          # replace 'C:\' with '/cygdrive/c/'
          RSYNC_SRC="${{RSYNC_SRC/C:\\//cygdrive/c/}}"
          # replace every (//) backslash '\' (\\) with (/)  slash '/' (/)
          RSYNC_SRC="${{RSYNC_SRC//\\//}}"

          # NOTE: solution from above is not tested when dealing with local Windows machine. But it should work.

          # FIXME: added -O  --no-perms - is a tmp solution hile testing on smb
          rsync -vrzaO --no-perms \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{RSYNC_PORT}}" \
            --rsync-path="mkdir -p ${{RSYNC_DST%/*}} && rsync" \
            "${{RSYNC_SRC}}" \
            "${{RSYNC_USER}}@${{RSYNC_HOST}}:${{RSYNC_DST}}"
        done

- builder:
    name: rsync-download
    builders:
    - shell: |
        #!/bin/bash
        set -ex

        RSYNC_HOST="{host}"
        RSYNC_PORT="{port}"
        RSYNC_USER="{user}"

        #TODO: Should we move files somewhere instead of deleting?
        if [ '{force}' == 'true' ] ; then
          echo "\nFORCE MODE\nWILL OVERRIDE ALL ARTIFACTS\n"
          echo "Clean dir first.."
          RSYNC_DST="{dst_path}"
            # replace 'C:\' with '/cygdrive/c/'
          RSYNC_DST="${{RSYNC_DST/C:\\//cygdrive/c/}}"
          # replace every (//) backslash '\' (\\) with (/)  slash '/' (/)
          RSYNC_DST="${{RSYNC_DST//\\//}}"
          rm -rf "${{RSYNC_DST}}"
          echo "Done"
        else
          echo "Ensure that components will not be overwritten..."
          if [ -e "{dst_path}" ] ; then
            echo "Here is a list of components currently located at the root of target directory."
            echo "Note, that '..' are also allowed as part paths."
            ls -la "{dst_path}"
          else
            echo "{dst_path} does not exist yet"
          fi

          echo "The components array is {components}"
          IFS=, read -ra COMPONENTS_ARRAY <<< "{components}"
          for COMPONENT in "${{COMPONENTS_ARRAY[@]}}"
          do
            RSYNC_DST="{dst_path}/${{COMPONENT}}"
            # When working with windows Jenkins node Workspace is represented as windows path.
            # Volume name ('C:') and back-slashes ('\') are error prone.
            # One of the option is to replace them with cygwin paths.

            # replace 'C:\' with '/cygdrive/c/'
            RSYNC_DST="${{RSYNC_DST/C:\\//cygdrive/c/}}"
            # replace every (//) backslash '\' (\\) with (/)  slash '/' (/)
            RSYNC_DST="${{RSYNC_DST//\\//}}"

            echo "Checking path \"${{RSYNC_DST}}\""
            if [ -e ${{RSYNC_DST}} ] ; then
              echo "Path exists. FAIL."
              exit 1
            fi
          done
        fi

        # components ~> "dir1/,dir2/,file1,file2"
        echo "Will rsync {components} components"

        IFS=, read -ra COMPONENTS_ARRAY <<< "{components}"
        for COMPONENT in "${{COMPONENTS_ARRAY[@]}}"
        do
          RSYNC_SRC="{src_path}/${{COMPONENT}}"
          RSYNC_DST="{dst_path}/${{COMPONENT}}"

          # When working with windows Jenkins node Workspace is represented as windows path.
          # Volume name ('C:') and back-slashes ('\') are error prone.
          # One of the option is to replace them with cygwin paths.

          # replace 'C:\' with '/cygdrive/c/'
          RSYNC_DST="${{RSYNC_DST/C:\\//cygdrive/c/}}"
          # replace every (//) backslash '\' (\\) with (/)  slash '/' (/)
          RSYNC_DST="${{RSYNC_DST//\\//}}"

          # replace 'C:\' with '/cygdrive/c/'
          RSYNC_SRC="${{RSYNC_SRC/C:\\//cygdrive/c/}}"
          # replace every (//) backslash '\' (\\) with (/)  slash '/' (/)
          RSYNC_SRC="${{RSYNC_SRC//\\//}}"

          # NOTE: solution from above is not tested when dealing with local Windows machine. But it should work.

          mkdir -p "${{RSYNC_DST%/*}}"

          # FIXME: added -O  --no-perms and removed -a - is a tmp solution hile testing on smb
          rsync -vrzO --no-perms \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{RSYNC_PORT}}" \
            "${{RSYNC_USER}}@${{RSYNC_HOST}}:${{RSYNC_SRC}}" \
            "${{RSYNC_DST}}"
        done
