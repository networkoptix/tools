- builder:
    name: run-functional-tests
    # Required template variables:
    #   test-select-expr (argument for -k, if not empty)
    #   test-list (space-delimited; empty means run all tests)
    #   test-timeout-hours
    #
    # Required environment variables:
    #   JUNK_SHOP_CAPTURE_DB (user:password@host[:port])
    #   AUTOTEST_EMAIL_PASSWORD
    #   JUNKSHOP_PROJECT_NAME
    #   BIN_DIR
    #   WORK_DIR
    #   EXECUTOR_NUMBER
    #   BRANCH
    #   BUILD_IDENTITY
    #   CUSTOMIZATION

    builders:
    - shell: |
        #!/bin/bash
        set -ex

        test -d "$BIN_DIR"
        mkdir -p "$WORK_DIR"

        VM_PORT_BASE=20000  # base for REST API ports forwarded from vm to host
        VM_PORT_RANGE=100  # how many forwarded ports one functional tests run may require, max
        VM_PORT=$(($VM_PORT_BASE + $EXECUTOR_NUMBER * $VM_PORT_RANGE))
        VM_NAME_PREFIX="funtest-$EXECUTOR_NUMBER-"

        source venv/bin/activate

          export PYTHONPATH=$WORKSPACE/devtools/ci/junk_shop
          export PYTEST_PLUGINS=junk_shop.pytest_plugin

          : ${{JUNK_SHOP_CAPTURE_DB:?}}  # reporting DB to be used by tests
          : ${{AUTOTEST_EMAIL_PASSWORD:?}}  # password for cloud accont

          cd nx_vms/func_tests

            export PYTEST_DEFAULTS_SECTION=ci  # init CI config

            if [[ "{test-select-expr}" != "" ]]; then
              EXTRA_OPTIONS="-k \"{test-select-expr}\""
            else
              EXTRA_OPTIONS=""
            fi

            pytest \
              --work-dir=$WORK_DIR \
              --bin-dir=$BIN_DIR \
              --mediaserver-installers-dir=$WORKSPACE/dist \
              --mediaserver-dist-path="$(echo $WORKSPACE/dist/*-server-*.deb)" \
              --customization=$CUSTOMIZATION \
              --cloud-group=$CLOUD_GROUP \
              --timeout=$(({test-timeout-hours} * 60*60)) \
              --capture-db=$JUNK_SHOP_CAPTURE_DB \
              --build-parameters=project=$JUNKSHOP_PROJECT_NAME,branch=$BRANCH,build_num=$BUILD_IDENTITY,platform=linux-x64,customization=$CUSTOMIZATION \
              --vm-port-base=$VM_PORT \
              --vm-name-prefix=$VM_NAME_PREFIX \
              --slot=$EXECUTOR_NUMBER \
              --reinstall \
              -v \
              $EXTRA_OPTIONS \
              {test-list}
