- builder:
    name: run-scalability-tests

    # Run scalability tests
    #
    # Required template variables:
    #   project
    #   branch
    #   build-num
    #   customization
    #   platform
    #   cloud-group
    #   bin-dir
    #   work-dir
    #   mediaserver-dist-dir
    #   clean ('true'/'True' or 'false'/'False')
    #   test-config  (path to tests config)
    #   use-lightweight-servers  ('true' or 'false')
    #   server-count  (integer)
    #   test-timeout-hours
    #
    # Required environment variables:
    #   JUNK_SHOP_CAPTURE_DB (user:password@host[:port])
    #   AUTOTEST_EMAIL_PASSWORD

    builders:

    - shell: |
        #!/bin/bash
        set -e
        echo
        echo '****************************************************************************************************'
        echo '*   use-lightweight-servers: {use-lightweight-servers}'
        echo '*   server-count: {server-count}'
        echo '****************************************************************************************************'

    - extended-bash:
        headers:
          !include-raw-escape: includes/join_by.sh
        script: |
          set -ex

          PARAMETERS=(
              "use_lightweight_servers={use-lightweight-servers}"
              "server_count={server-count}"
              "storages_per_server={storages-per-server}"
              "cameras_per_server={cameras-per-server}"
              "users_per_server={users-per-server}"
              "properties_per_camera={properties-per-camera}"
              "merge_timeout={merge-timeout}"
              )
          echo > PARAMETERS.envvar
          echo "RUN_PARAMETERS=$(join_by ',' ${{PARAMETERS[@]}})" >> PARAMETERS.envvar
          echo "TEST_PARAMETERS=scalability_test.$(join_by ',scalability_test.' ${{PARAMETERS[@]}})" >> PARAMETERS.envvar

    - inject:
        properties-file: 'PARAMETERS.envvar'

    - run-functional-tests:
        project: '{project}'
        branch: '{branch}'
        build-num: '{build-num}'
        customization: '{customization}'
        platform: linux-x64
        cloud-group: '{cloud-group}'
        bin-dir: '{bin-dir}'
        work-dir: '{work-dir}'
        mediaserver-dist-dir: '{mediaserver-dist-dir}'
        clean: '{clean}'
        test-args: >-
          --run-name=scalability
          --tests-config-file={test-config}
          --test-parameters=$TEST_PARAMETERS
          --run-parameters=$RUN_PARAMETERS
        test-select-expr: ''
        test-list: 'tests/scalability_test.py'
        test-timeout-hours: '{test-timeout-hours}'
