- builder:
    name: run-scalability-tests
    # Required template variables:
    #   use-lightweight-servers
    #   server-count
    #
    # Required environment variables:
    #   JUNKSHOP_PROJECT_NAME
    #   BIN_DIR
    #   WORK_DIR
    #   EXECUTOR_NUMBER
    #   BRANCH
    #   BUILD_IDENTITY
    #   CUSTOMIZATION
    #   JUNK_SHOP_DB_CREDENTIALS
    #   JUNKSHOP_DB_HOST

    builders:
    - shell: |
        #!/bin/bash
        echo '****************************************************************************************************'
        echo '*   use-lightweight-servers: {use-lightweight-servers}'
        echo '*   server-count: {server-count}'
        echo '****************************************************************************************************'
        set -ex

        test -d "$BIN_DIR"
        mkdir -p "$WORK_DIR"

        if [ ! -d venv ]; then
          virtualenv --system-site-packages venv
        fi

        source venv/bin/activate
          pip install --upgrade pip setuptools wheel
          pip install --upgrade -r devtools/ci/junk_shop/requirements.txt
          pip install --upgrade -r nx_vms/func_tests/requirements.txt

          export PYTHONPATH=$WORKSPACE/devtools/ci/junk_shop
          export PYTEST_PLUGINS=junk_shop.pytest_plugin

          STORAGES_PER_SERVER=1
          CAMERAS_PER_SERVER=20
          USERS_PER_SERVER=4
          PROPERTIES_PER_CAMERA=5
          MERGE_TIMEOUT=2h
          TEST_TIMEOUT="$((4 * 60 * 60))" # 4hr

          cd nx_vms/func_tests

            export PYTEST_DEFAULTS_SECTION=ci  # init CI config
            pytest \
              --work-dir=$WORK_DIR \
              --bin-dir=$BIN_DIR \
              --mediaserver-installers-dir=$WORKSPACE/dist \
              --mediaserver-dist-path="$(echo $WORKSPACE/dist/*-server-*.deb)" \
              --customization=$CUSTOMIZATION \
              --cloud-group=test \
              --timeout=$TEST_TIMEOUT \
              --capture-db=$JUNK_SHOP_DB_CREDENTIALS@$JUNKSHOP_DB_HOST \
              --build-parameters="\
        project=$JUNKSHOP_PROJECT_NAME,\
        branch=$BRANCH,\
        build_num=$BUILD_IDENTITY,\
        platform=linux-x64,\
        customization=$CUSTOMIZATION" \
              --vm-port-base=$((20000 + $EXECUTOR_NUMBER * 100)) \
              --vm-name-prefix=funtest-$EXECUTOR_NUMBER- \
              --slot=$EXECUTOR_NUMBER \
              --reinstall \
              -v \
              --run-name=scalability \
              --tests-config-file=$WORKSPACE/test-config.yaml \
              --test-parameters="\
        scalability_test.use_lightweight_servers={use-lightweight-servers},\
        scalability_test.server_count={server-count},\
        scalability_test.storages_per_server=$STORAGES_PER_SERVER,\
        scalability_test.cameras_per_server=$CAMERAS_PER_SERVER,\
        scalability_test.users_per_server=$USERS_PER_SERVER,\
        scalability_test.properties_per_camera=$PROPERTIES_PER_CAMERA,\
        scalability_test.merge_timeout=$MERGE_TIMEOUT" \
              --run-parameters="\
        use_lightweight_servers={use-lightweight-servers},\
        server_count={server-count},\
        storages_per_server=$STORAGES_PER_SERVER,\
        cameras_per_server=$CAMERAS_PER_SERVER,\
        users_per_server=$USERS_PER_SERVER,\
        properties_per_camera=$PROPERTIES_PER_CAMERA,\
        merge_timeout=$MERGE_TIMEOUT" \
              tests/scalability_test.py

- builder:
    name: scalability-tests-block
    builders:
    - run-scalability-tests:
        use-lightweight-servers: '{use-lightweight-servers}'
        server-count: '{server-count}'
