# This builder should be used in pre-scm step
# We are experiencing significant problems with repo checkout
# since mercurial always pulls entire repo.
#
# In logic below we are keeping some cached hg repo and use it
# for clean checkout.
# this may save us up to 40min of pulling.
- builder:
    name: copy-hg-repo
    builders:
    - conditional-step:
        condition-kind: boolean-expression
        condition-expression: '${{ENV,var="CLEAN_CLONE"}}'
        steps:
        - folder-delete-operation:
            folder-path: '$WORKSPACE/{name}'
    - conditional-step:
        condition-kind: not
        condition-operand:
          condition-kind: file-exists
          condition-filename: '$WORKSPACE/{name}/.hg'
          condition-basedir: workspace
        steps:
        - trigger-builds:
          - project: 'helper.sync-hg'
            predefined-parameters: |
              SSH_USER=$USER
              LOCAL_PATH=$WORKSPACE
              REPO={name}
              NODE_SSH_CONNECTION=$SSH_CONNECTION
            block: true
            block-thresholds:
              failure-threshold: FAILURE