# This builder should be used in pre-scm step
# We are experiencing significant problems with repo checkout
# since mercurial always pulls entire repo.
#
# In logic below we are keeping some cached hg repo and use it
# for clean checkout.
# this may save us up to 40min of pulling.

- builder:
    name: import-hg-repo(if-missing)
    builders:
    - conditional-step:
        condition-kind: boolean-expression
        condition-expression: '${{ENV,var="CLEAN_CLONE"}}'
        steps:
        - folder-delete-operation:
            folder-path: '$WORKSPACE/{name}'

    - conditional-step:
        condition-kind: not
        condition-operand:
          condition-kind: file-exists
          condition-filename: '$WORKSPACE/{name}/.hg'
          condition-basedir: workspace
        steps:
        - trigger-builds:
          - project: '{pipeline}.helper.sync-hg'
            # LOCAL_PATH= $WORKSPACE -> {dest-workspace}
            predefined-parameters: |
              SSH_USER=$USER
              LOCAL_PATH={basedir}
              REPO={name}
              BRANCH={branch}
              PLATFORM={platform}
              CUSTOMIZATION={customization}
              NODE_SSH_CONNECTION=$SSH_CONNECTION
            block: true
            block-thresholds:
              failure-threshold: FAILURE
