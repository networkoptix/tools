# TODO: find-out if it's possible to split this into 2 manipulations

- wrapper:
    name: pre-scm-repo-manipulations-2
    # This wrapperhelps with hg repo juggling
    # We are experiencing significant problems with repo checkout
    # since mercurial always pulls entire repo.

    # in logic below we are keeping some cached hg repo and use it
    # for clean checkout.
    # this may save us up to 40min of pulling.

    wrappers:
    - pre-scm-buildstep:
        failOnError: true
        buildsteps:
        - conditional-step:
            condition-kind: boolean-expression
            condition-expression: '${{ENV,var="CLEAN_CLONE"}}'
            steps:
            # clean repository files
            - folder-delete-operation:
                folder-path: $WORKSPACE/devtools
            - folder-delete-operation:
                folder-path: $WORKSPACE/nx_vms
        - conditional-step:
            condition-kind: not
            condition-operand:
              condition-kind: file-exists
              condition-filename: $WORKSPACE/devtools/.hg
              condition-basedir: workspace
            steps:
            - trigger-builds:
              - project: 'helper.sync-hg'
                predefined-parameters: |
                  SSH_USER=$USER
                  LOCAL_PATH=$WORKSPACE
                  REPO=devtools
                  NODE_SSH_CONNECTION=$SSH_CONNECTION
                block: true
                block-thresholds:
                  failure-threshold: FAILURE
        - conditional-step:
            condition-kind: not
            condition-operand:
              condition-kind: file-exists
              condition-filename: $WORKSPACE/nx_vms/.hg
              condition-basedir: workspace
            steps:
            - trigger-builds:
              - project: 'helper.sync-hg'
                predefined-parameters: |
                  SSH_USER=$USER
                  LOCAL_PATH=$WORKSPACE
                  REPO=nx_vms
                  NODE_SSH_CONNECTION=$SSH_CONNECTION
                block: true
                block-thresholds:
                  failure-threshold: FAILURE

- wrapper:
    name: pre-scm-repo-manipulations-1
    # This wrapperhelps with hg repo juggling
    # We are experiencing significant problems with repo checkout
    # since mercurial always pulls entire repo.

    # in logic below we are keeping some cached hg repo and use it
    # for clean checkout.
    # this may save us up to 40min of pulling.

    wrappers:
    - pre-scm-buildstep:
        failOnError: true
        buildsteps:
        - conditional-step:
            condition-kind: boolean-expression
            condition-expression: '${{ENV,var="CLEAN_CLONE"}}'
            steps:
            - folder-delete-operation:
                folder-path: $WORKSPACE/nx_vms
        - conditional-step:
            condition-kind: not
            condition-operand:
              condition-kind: file-exists
              condition-filename: $WORKSPACE/nx_vms/.hg
              condition-basedir: workspace
            steps:
            - trigger-builds:
              - project: 'helper.sync-hg'
                predefined-parameters: |
                  SSH_USER=$USER
                  LOCAL_PATH=$WORKSPACE
                  REPO=nx_vms
                  NODE_SSH_CONNECTION=$SSH_CONNECTION
                block: true
                block-thresholds:
                  failure-threshold: FAILURE
