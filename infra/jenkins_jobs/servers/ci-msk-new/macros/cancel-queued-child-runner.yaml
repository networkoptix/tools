- builder:
    name: cancel-queued-child-runner
    builders:
    - system-groovy:
        command: !j2: |
          {% if cancel | default(true) %}
          import jenkins.model.Jenkins;
          import hudson.model.Result;

          // instance of hudson.model.FreeStyleBuild
          // https://javadoc.jenkins.io/hudson/model/FreeStyleBuild.html
          def currentBuild = Thread.currentThread().executable;

          // instance of hudson.EnvVars
          // https://javadoc.jenkins-ci.org/hudson/EnvVars.html
          def env = Thread.currentThread().executable.getEnvVars();

          def jobname  = env.get("JOB_NAME");
          def job = Jenkins.instance.getItemByFullName(jobname)

          def q = Jenkins.instance.queue
          q.items.each {
            def sameParentJob = false;
            def isRunnerJob = false;
            def isReplaceable = false;
            def parentBuildId = 0;

            // We are searching for runners started by the same job which
            // are still in queue and allowed to be replced == cancelled

            if ( it.task.name.endsWith(".runner")) {
                isRunnerJob = true;
            }

            it.params.split('\n').each {
              if ( it.startsWith("REQUESTED_BY=${jobname}-")) {
                sameParentJob = true;
                parentBuildId = it.tokenize('-').last()

              }
              if ( it.startsWith("REPLACE_BUILD_WITH_NEWER=YES")) {
                isReplaceable = true;
              }
            }
            // We found one of such builds
            if ( sameParentJob && isRunnerJob && isReplaceable ) {
              // todo: try/catch
              // cancel scheduled runner -> will abort parent build
              q.cancel( it.task );
              // get that parent and change it's description and status to grey
              def parentBuild = job.getBuildByNumber(parentBuildId.toInteger());
              parentBuild.setDescription("ABORTED IN FAV OF NEWER BUILD");
              parentBuild.@result = hudson.model.Result.ABORTED
            }
          }
          {% endif %}
