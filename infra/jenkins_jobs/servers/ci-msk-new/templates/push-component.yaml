- job-template:
    name: 'helper.push-component'

    node: repository-ops
    concurrent: false  # important

    properties:
    - heavy-job:
        weight: 1
    - throttle:
        max-total: 1
        option: project
    - build-discarder:
        days-to-keep: 10
        num-to-keep: 50
        artifact-days-to-keep: 10
        artifact-num-to-keep: 50

    parameters:
    - p_REQUESTED_BY
    - bool:
        name: IS_SUCCESSFUL
        default: true
        description: >-
          Special flag to mark partial and/or faild builds, they should
          go to other repository than final one with good artifacts.
    - p_BUILD_DESCRIPTION:
        default: ''
    # Parameters related to artifact location in repository
    - p_PIPELINE
    - p_BRANCH
    - p_BUILD_IDENTITY
    - p_PLATFORM
    - p_CUSTOMIZATION
    - p_COMPONENTS
    # Parameter that defines path to operate it's actually remote path
    - p_LOCAL_PATH
    # Utility parameters used to describe connection details
    - p_NODE_SSH_CONNECTION
    - p_SSH_USER

    - administrative-section-separator
    - string:
        name: FORCE_PUSH
        default: 'false'
        description: "Delete existing artifacts before pushing."

    wrappers:
    - build-name:
        name: '#$BUILD_ID $BUILD_IDENTITY $BRANCH $PLATFORM $CUSTOMIZATION'
    - timestamps
    - timeout:
        # normally, should complete in 2-10 min
        timeout: 30 # min
        fail: true
        type: absolute
    - ssh-agent-credentials:
        users:
        - jenkins

    builders:
    - inject:
        properties-content: |
          RUNNING_NUM=$BUILD_ID
    - shell: |
        #!/bin/bash
        : ${{REQUESTED_BY:?}}
        : ${{BUILD_IDENTITY:?}}
        : ${{CUSTOMIZATION:?}}
        : ${{PLATFORM:?}}
    # in rare case when build failed somewhere in checkout state some vars are undefined and passed as is
    # anyways build will try to upload artifacts.
    - shell: |
        #!/bin/bash
        set -ex
        test "$BRANCH" != '$BRANCH'
        test "$PIPELINE" != '$PIPELINE'
        test "$BUILD_IDENTITY" != '$BUILD_IDENTITY'
        test "$CUSTOMIZATION" != '$CUSTOMIZATION'
        test "$COMPONENTS" != '$COMPONENTS'

    - shell: |
        #!/bin/bash
        if [ "${{IS_SUCCESSFUL}}" == 'true' ] ; then
          REPOSITORY_PATH="{artifact_repository_base_path}/{artifact_location_full_pattern}"
          REPOSITORY_URL="{artifact_repository_base_url}/{artifact_location_full_pattern}"
        else
          REPOSITORY_PATH="{artifact_repository_base_path}/{artifact_location_full_pattern_failed}"
          REPOSITORY_URL="{artifact_repository_base_url}/{artifact_location_full_pattern_failed}"
        fi
        echo "REPOSITORY_PATH=${{REPOSITORY_PATH}}" > REPOSITORY_PATH.envvar
        echo "REPOSITORY_URL=${{REPOSITORY_URL}}" > REPOSITORY_URL.envvar
    - inject:
        properties-file: REPOSITORY_PATH.envvar
    - inject:
        properties-file: REPOSITORY_URL.envvar

    - description-setter:
        description: |
          $REPOSITORY_URL

    - rsync-download:
        host: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 3)'
        port: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 4)'
        user: '${{SSH_USER}}'
        src_path: '${{LOCAL_PATH}}'
        dst_path: '${{REPOSITORY_PATH}}'
        components: '${{COMPONENTS}}'
        force: '$FORCE_PUSH'

    publishers:
    - archive:
        artifacts: 'REPOSITORY_PATH.envvar'
        allow-empty: 'false'
        fingerprint: true
    - archive:
        artifacts: 'REPOSITORY_URL.envvar'
        allow-empty: 'false'
        fingerprint: true

    - failure-email-helpers(maintainers)