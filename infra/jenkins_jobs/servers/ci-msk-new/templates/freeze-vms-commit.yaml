- job-template:
    name: '{pipeline}.{branch}.vms.freeze_nx_vms_commit'
    project-type: multijob

    node: '{commit-freeze-node}'
    concurrent: false  # important

    properties:
    - heavy-job:
        weight: 1
    - throttle:
        max-total: 10
        option: project
    - build-discarder:
        days-to-keep: 30
        num-to-keep: 100
        artifact-days-to-keep: 30
        artifact-num-to-keep: 100

    parameters:
    - p_REQUESTED_BY
    - p_CLEAN_CLONE
    - p_NX_VMS_COMMIT:
        default: '{branch}'

    wrappers:
    - build-name:
        name: '[${{BUILD_ID}}] {branch}-${{BUILD_IDENTITY}}@${{NX_VMS_COMMIT}}'
    - timestamps
    - timeout:
        # normally should complete in 2-5 min
        timeout: 20 # min
        fail: true
        type: absolute
    - copy-hg-repo(1):
        name: nx_vms

    scm:
    - hg-la-anon:
        project-name: nx_vms
        branch-name: '$NX_VMS_COMMIT'

    builders:
    # Clean repository files as we don't need them actually
    # - folder-delete-operation:
    #     folder-path: $WORKSPACE/nx_vms

    - shell: |
        #!/bin/bash
        set -ex
        echo "NX_VMS_COMMIT=${{MERCURIAL_REVISION_SHORT}}" > 'NX_VMS_COMMIT.envvar'

    publishers:
    - archive:
        artifacts: 'NX_VMS_COMMIT.envvar'
        allow-empty: 'false'
        fingerprint: true