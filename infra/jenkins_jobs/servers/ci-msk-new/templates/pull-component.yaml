- job-template:
    name: 'helper.pull-component'

    node: repository-ops
    concurrent: true

    properties:
    - heavy-job:
        weight: 1
    - build-discarder:
        days-to-keep: 30
        num-to-keep: 100
        artifact-days-to-keep: 30
        artifact-num-to-keep: 100
    - throttle:
        max-total: 3
        option: project

    parameters:
    - p_BUILD_DESCRIPTION:
        default: ''
    # Parameters related to artifact location in repository
    - p_PIPELINE
    - p_BRANCH
    - p_BUILD_IDENTITY
    - p_CUSTOMIZATION
    - p_PLATFORM
    - p_COMPONENTS
    # Parameter that defines path to operate it's actually remote path
    - p_LOCAL_PATH
    # Utility parameters used to describe connection details
    - p_NODE_SSH_CONNECTION
    - p_SSH_USER
    - p_BUILD_STATUS
    - p_RUNNING_NUM

    wrappers:
    - build-name:
        name: '#$BUILD_ID $BUILD_IDENTITY $BRANCH $PLATFORM $CUSTOMIZATION'
    - timestamps
    - timeout:
        # normally, should complete in 5-10 min
        timeout: 30 # min
        fail: true
        type: absolute
    - ssh-agent-credentials:
        users:
        - jenkins

    builders:
    - shell: |
        #!/bin/bash
        if [ "${{BUILD_STATUS}}" == 'passed' ] ; then
          REPOSITORY_PATH="{artifact_repository_base_path}/{artifact_location_full_pattern}"
        else
          REPOSITORY_PATH="{artifact_repository_base_path}/{artifact_location_full_pattern_failed}"
        fi
        echo "REPOSITORY_PATH=${{REPOSITORY_PATH}}" > REPOSITORY_PATH.envvar
    - inject:
        properties-file: REPOSITORY_PATH.envvar

    - rsync-upload:
        host: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 3)'
        port: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 4)'
        user: '${{SSH_USER}}'
        src_path: '${{REPOSITORY_PATH}}'
        dst_path: '${{LOCAL_PATH}}'
        components: '${{COMPONENTS}}'

    publishers:
    - failure-email-helpers(maintainers)