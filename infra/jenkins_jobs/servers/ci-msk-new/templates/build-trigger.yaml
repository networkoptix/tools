- job-template:
    name: '{pipeline}.{branch}.vms.trigger.{preset}'
    job-maintainers: 'iremizov@networkoptix.com'
    description: |
      <pre>
      ================================================================================
      Build Trigger
      ================================================================================

      JOB MAINTAINERS
        {job-maintainers}
        (NOT notified by email on build failures)

      SOURCES
        devtools/infra/jenkins_jobs/servers/templates/build-trigger.yaml

      --------------------------------------------------------------------------------

      This job serves for starting bunch of builds associated with particular commit
      in nx_vms repository and also assigned build identity.

      By default (e.g. triggered automatically) it will build following installers
      {platforms}
      {customizations}

      There are some different triggers available.
      See all triggers on {jenkins_host}/view/triggers/

      {detailed-job-description}

      See more details on build procedure in corresponding downstream "*.runner" job

      --------------------------------------------------------------------------------
      </pre>
    node: runner
    concurrent: true

    timer: ''  # no timed trigger by default
    clean-build: '' # false by default
    default-build-description: ''
    # detailed-job-description required!

    # vars
    tag_requested_by: $JOB_NAME-$BUILD_NUMBER

    properties:
    - heavy-job:
        weight: 1
    - throttle:
        max-total: 10
        option: project
    - build-discarder:
        days-to-keep: 30
        num-to-keep: 100
        artifact-days-to-keep: 30
        artifact-num-to-keep: 100

    parameters:
    - p_BUILD_DESCRIPTION:
        default: '{default-build-description}'
    - simple-separator:
        header: Build parameters
    - p_CLEAN_BUILD:
        default: '{clean-build}'
    # FIXME: Figure out why extended choice created from JJB is not visible..
    - p_PLATFORMS:
        default: '{platforms}'
    - p_CUSTOMIZATIONS:
        default: '{customizations}'
    - string:
        name: _NX_VMS_COMMIT
        default: '{branch}'
    - bool:
        name: FREEZE_COMMIT_NOW
        default: false
        description: Freeze nx_vms commit right now, don't wait for starting builds


    triggers:
    - timed: "{timer}"

    wrappers:
    # NOTE: There is abug in jenkins: vars set here are read-only and can not be modified.
    - inject:
        properties-content: |
          JOB_MAINTAINERS={job-maintainers}
          BRANCH={branch}
          PIPELINE={pipeline}
    - timestamps
    # note: DO NOT ADD any timeouts here. Put them in corresponding child jobs.

    builders:

    - inject:
        properties-content: |
          BUILD_IDENTITY=undef
          NX_VMS_COMMIT=undef

    # Runner itself may freeze commits (when runner is triggered directly)
    # But we want to allow users to freeze commit by the time this job is triggered

    # inject given ref at first
    - inject:
        properties-content: |
          NX_VMS_COMMIT=$_NX_VMS_COMMIT

    # freeze if needed and overwrite
    - conditional-step:
        condition-kind: boolean-expression
        condition-expression: '${{ENV,var="FREEZE_COMMIT_NOW"}}'
        steps:
        - trigger-builds:
          - project: 'helper.freeze-nx-vms-commit'
            block: true
            predefined-parameters: |
              REQUESTED_BY={tag_requested_by}
              BRANCH=$BRANCH
              PIPELINE=$PIPELINE
              NX_VMS_COMMIT=$_NX_VMS_COMMIT
              BUILD_DESCRIPTION=$BUILD_DESCRIPTION
        - copyartifact:
            project: 'helper.freeze-nx-vms-commit'
            filter: 'NX_VMS_COMMIT.envvar'
            which-build: last-completed
            parameter-filters: REQUESTED_BY={tag_requested_by}
        - inject:
            properties-file: 'NX_VMS_COMMIT.envvar'

    - description-setter:
        description: |
          $PLATFORMS $CUSTOMIZATIONS for $NX_VMS_COMMIT ($_NX_VMS_COMMIT)
    - description-setter:
        description: |
          $BUILD_DESCRIPTION

    # We don't use multijob to hide dependency graph from trigger because graph
    # is too big and takes a while to be loaded
    # Anyway this graph is available in runner
    - trigger-builds:
      - project: '{pipeline}.{branch}.vms.runner'
        predefined-parameters: |
          REQUESTED_BY={tag_requested_by}
          BUILD_DESCRIPTION=$BUILD_DESCRIPTION
          PLATFORMS=$PLATFORMS
          CUSTOMIZATIONS=$CUSTOMIZATIONS
          _NX_VMS_COMMIT=$NX_VMS_COMMIT
          CLEAN_BUILD=$CLEAN_BUILD
        block: true
        block-thresholds:
          failure-threshold: FAILURE

    publishers:
    - postbuildscript:
        mark-unstable-if-failed: true
        builders:
        - role: SLAVE
          build-on:
          - SUCCESS
          - UNSTABLE
          - FAILURE
          - NOT_BUILT
          - ABORTED
          build-steps:
          - copyartifact:
              project: '{pipeline}.{branch}.vms.runner'
              filter: 'NX_VMS_COMMIT.envvar,BUILD_IDENTITY.envvar'
              which-build: last-completed
              parameter-filters: REQUESTED_BY={tag_requested_by}
          - inject:
              properties-file: 'NX_VMS_COMMIT.envvar'
          - inject:
              properties-file: 'BUILD_IDENTITY.envvar'

    - publisher-set-build-name:
        name: '#$BUILD_ID $BRANCH-$BUILD_IDENTITY@$NX_VMS_COMMIT'

    - completed-email(group)
    # TODO: decide if we want to receive errors on each build...
    # - failure-email(maintainers) # TODO:
