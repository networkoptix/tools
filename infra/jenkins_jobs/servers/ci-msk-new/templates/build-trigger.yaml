- job-template:
    name: '{pipeline}.{branch}.{project}.trigger.{preset}'
    job-maintainers: 'iremizov@networkoptix.com'

    description: |
      <pre>
      ================================================================================
      Build Trigger
      ================================================================================

      JOB MAINTAINERS
        {job-maintainers}
        (NOT notified by email on build failures)

      SOURCES
        devtools/infra/jenkins_jobs/servers/templates/build-trigger.yaml

      --------------------------------------------------------------------------------

      This job serves for starting bunch of builds associated with particular commit
      in nx_vms repository and also assigned build identity.

      By default (e.g. triggered automatically) it will build following installers
      {platforms}
      {customizations}

      There are some different triggers available.
      See all triggers on {jenkins_host}/view/triggers/

      {detailed-job-description}

      See more details on build procedure in corresponding downstream "*.runner" job

      Note, that this job doesn't wait for downstream build completion.
      Find your build in crsp build queue

      --------------------------------------------------------------------------------
      </pre>
    # all build triggers will work under the same workspace as well as
    node: '{hg-local-cache-node}'
    workspace: '{hg-local-cache-node-workspace}'
    concurrent: false

    timer: ''  # no timed trigger by default
    poll-scm-timer: '' # no scm polling by default
    freeze-commit-now: true # default true
    clean-build: '' # false by default
    default-build-description: ''
    build-webadmin: true
    # detailed-job-description required!

    # vars
    tag_requested_by: $JOB_NAME-$BUILD_NUMBER

    properties:
    - heavy-job:
        weight: 1
    - throttle:
        option: category
        max-total: 1
        categories:
        - '{hg-local-cache-node-throttle-category}'
    - build-discarder:
        days-to-keep: 10
        num-to-keep: 50
        artifact-days-to-keep: 10
        artifact-num-to-keep: 50

    parameters:
    - p_BUILD_DESCRIPTION:
        default: '{default-build-description}'
    - simple-separator:
        header: Build parameters
    - p_CLEAN_BUILD:
        default: '{clean-build}'
    # FIXME: Figure out why extended choice created from JJB is not visible..
    - p_PLATFORMS:
        default: '{platforms}'
    - p_CUSTOMIZATIONS:
        default: '{customizations}'
    - p_BUILD_WEBADMIN:
        default: '{build-webadmin}'
    - string:
        name: _NX_VMS_COMMIT
        default: '{branch}'
    - bool:
        name: FREEZE_COMMIT_NOW
        default: '{freeze-commit-now}'
        description: Freeze nx_vms commit right now, don't wait for starting builds

    triggers:
    - timed: "{timer}"
    - pollscm:
        cron: "{poll-scm-timer}"
        ignore-post-commit-hooks: True

    wrappers:
    # NOTE: There is abug in jenkins: vars set here are read-only and can not be modified.
    - inject:
        properties-content: |
          JOB_MAINTAINERS={job-maintainers}
    - timestamps
    - timeout:
        # normally should complete in <1 min, but in case of clean clone this may not work
        # if there is no repo cloned yet, copy/clone it manually or change timeout
        timeout: 5 # min
        fail: true
        type: absolute

    scm:
    - hg-la:
        project-name: nx_vms
        branch-name: '$_NX_VMS_COMMIT'

    builders:
    - inject:
        properties-content: |
          PIPELINE={pipeline}
          BRANCH={branch}

    - description-setter:
        description: |
          $BUILD_DESCRIPTION

    # inject given ref at first
    - shell: |
        #!/bin/bash
        set -ex
        echo "NX_VMS_COMMIT=${{_NX_VMS_COMMIT}}" > 'NX_VMS_COMMIT.envvar'
    - inject:
        properties-file: NX_VMS_COMMIT.envvar

    # freeze if needed and overwrite
    - conditional-step:
        condition-kind: boolean-expression
        condition-expression: '${{ENV,var="FREEZE_COMMIT_NOW"}}'
        steps:
        - shell: |
            #!/bin/bash
            set -ex
            echo "NX_VMS_COMMIT=${{MERCURIAL_REVISION_SHORT}}" > 'NX_VMS_COMMIT.envvar'
        - inject:
            properties-file: NX_VMS_COMMIT.envvar

    # We don't use multijob to hide dependency graph from trigger because graph
    # is too big and takes a while to be loaded
    # Anyway this graph is available in runner
    - trigger-builds:
      - project: '{pipeline}.{branch}.{project}.runner'
        predefined-parameters: |
          REQUESTED_BY={tag_requested_by}
          BUILD_DESCRIPTION=$BUILD_DESCRIPTION
          BUILD_WEBADMIN=$BUILD_WEBADMIN
          PLATFORMS=$PLATFORMS
          CUSTOMIZATIONS=$CUSTOMIZATIONS
          _NX_VMS_COMMIT=$NX_VMS_COMMIT
          CLEAN_BUILD=$CLEAN_BUILD
        block: false # !! don't wait
        block-thresholds:
          failure-threshold: FAILURE

    publishers:
    - publisher-set-build-name:
        name: '#$BUILD_ID $BRANCH@$NX_VMS_COMMIT'
    - archive:
        artifacts: 'NX_VMS_COMMIT.envvar'
        allow-empty: 'false'
        fingerprint: true
    - failure-email-helpers(maintainers)
