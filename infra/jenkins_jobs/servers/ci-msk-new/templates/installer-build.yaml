

- job-template:
    name: '{pipeline}.{branch}.vms.installer.{platform}.{customization}.build'
    node: '{installer-build-node}'
    workspace: '{workspace}'

    parameters:
    - p_CLEAN_WORKSPACE
    - p_CLEAN_CLONE
    - p_CLEAN_BUILD
    - p_BUILD_IDENTITY
    - p_NX_VMS_COMMIT:
        default: '{branch}'

    wrappers:
    - timestamps
    - workspace-cleanup:
        check-parameter: CLEAN_WORKSPACE

    # STAGE: PRE-SCM
    # ========================================

    - pre-scm-repo-manipulations-2:
        cached_hg_repository_base: '{cached_hg_repository_base}'

    # STAGE: SCM
    # ========================================

    scm:
    - hg-la:
        project-name: devtools
        branch-name: default
    - hg-la:
        project-name: nx_vms
        branch-name: $NX_VMS_COMMIT

    builders:

    # STAGE: CLEANUP
    # ========================================

    # Optionally remove entire build directory
    - conditionally-clean-dir:
        condition-varname: CLEAN_BUILD
        dir: build

    # Unconditionally ensure that all artifacts that may be left in workspace after
    # any previous build process are removed

    # Remove CMake caches
    - file-delete-operation:
        includes: build/CMakeCache.txt
        excludes: ''

    # Remove distrib folder
    - folder-delete-operation:
        folder-path: build/distrib

    # Run custom cleaner provided by development team
    # TODO: display content of file
    - conditional-step:
        condition-kind: file-exists
        condition-filename: '{custom_cleaner_path}'
        condition-basedir: workspace
        steps:
        - run-process:
            workdir: $WORKSPACE/build
            executable: python
            executable-is-relpath: 'false'
            arguments: '{custom_cleaner_path},--build-dir,$WORKSPACE/build'
            logfile: build/cleaner.log
            inherit-environ: 'true'
            environ: ''

    # STAGE: SETUP BUILD ENVIRONMENT
    # ========================================

    # Create build folder
    # TODO: Check that condition is really needed
    - conditional-step:
        condition-kind: not
        condition-operand:
          condition-kind: file-exists
          condition-filename: build
          condition-basedir: workspace
        steps:
        - folder-create-operation:
            folder-path: 'build'

    # Fetch dependencies
    - inject:
        properties-content: |
          REPOSITORY_PATH={artifact_repository_base}/{pipeline}/$BUILD_IDENTITY/
    - folder-copy-operation:
        source-folder-path: '$REPOSITORY_PATH/server-external'
        destination-folder-path: $WORKSPACE/server-external

    # STAGE: BUILD
    # ========================================

    - inject:
        properties-content: |
          PIPELINE={pipeline}
          CUSTOMIZATION={customization}
          {cmake_configure_args_global}
    - inject:
        properties-content: |
          {cmake_configure_args_pipeline}
    - inject:
        properties-content: |
          {cmake_configure_args_platform}
    - inject:
        properties-content: |
          {cmake_configure_args_customization}
    - inject:
        properties-content: |
          CMAKE_ARG_customWebAdminPackageDirectory=$WORKSPACE/server-external
          CMAKE_ARG_buildNumber=$BUILD_IDENTITY
          CMAKE_SOURCEDIR=../nx_vms
          CMAKE_ENV_NINJA_STATUS="[%s/%t] %es "
          CMAKE_ENV__MSPDBSRV_ENDPOINT_=executor-$EXECUTOR_NUMBER
          CMAKE_ENV_environment=$WORKSPACE
          environment=$WORKSPACE
    - inject:
        properties-content: |
          WORKDIR=$WORKSPACE/build
          EXECUTABLE=cmake
          EXECUTABLE_IS_RELPATH=false
          LOGFILE=build/cmake-configure-{customization}.log
          INHERIT_ENVIRON=true
    - groovy:
        version: '{groovy-version}'
        command: !include-raw-escape: ../builders/cmake_configure_wrapper.groovy

    # Build
    - inject:
        properties-content: |
          WORKDIR=$WORKSPACE/build
          EXECUTABLE=cmake
          LOGFILE=build/cmake-build-{customization}.log
          INHERIT_ENVIRON=true
          ENVIRON=NINJA_STATUS=[%s/%t] %es ,_MSPDBSRV_ENDPOINT_=executor-$EXECUTOR_NUMBER,environment=$WORKSPACE
    - groovy:
        version: '{groovy-version}'
        command: !include-raw-escape: ../builders/cmake_build_wrapper.groovy

    # STAGE: PUBLISH
    # ========================================

    publishers:
    - archive:
        artifacts: 'build/*.log'
        allow-empty: 'false'
        fingerprint: true

    - artifact-deployer:
        entries:
        - files: !join:
            - ','
            -
              - build_info.txt
              - distrib/
              - bin/
              - current_config.py
          basedir: '$WORKSPACE/build'
          remote: '{artifact_repository_base}/{pipeline}/$BUILD_IDENTITY/'
          delete-remote: false
          delete-remote-artifacts: false