- job-template:
    name: 'helper.sync-hg'

    node: hg-sync
    concurrent: true

    properties:
    - heavy-job:
        weight: 1
    - throttle:
        max-total: 5
        option: project
    - build-discarder:
        days-to-keep: 10
        num-to-keep: 25
        artifact-days-to-keep: 10
        artifact-num-to-keep: 25

    parameters:
    - p_BUILD_DESCRIPTION:
        default: ''
    - string:
        name: REPO
        description: >
          Which hg repo to sync, devtools or nx_vms
    - p_LOCAL_PATH
    - p_NODE_SSH_CONNECTION
    - p_SSH_USER

    wrappers:
    - build-name:
        name: '#${{BUILD_ID}}'
    - timestamps
    - timeout:
        # normally, should complete in 2-10 min
        timeout: 20 # min
        fail: true
        type: absolute
    - ssh-agent-credentials:
        users:
        - jenkins

    builders:
    - description-setter:
        description: |
          $BUILD_DESCRIPTION

    - rsync-upload:
        host: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 3)'
        port: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 4)'
        user: '${{SSH_USER}}'
        src_path: '{cached_hg_repository_base_path}/${{REPO}}/'
        dst_path: '${{LOCAL_PATH}}/${{REPO}}/'
        components: '.hg/'
