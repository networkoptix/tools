

- job-template:
    name: 'helper.freeze-nx-vms-commit'
    description: |
      <pre>
      ================================================================================
      Freeze nx_vms commit
      ================================================================================

      JOB MAINTAINERS
        {job-maintainers}
        (notified by email on build failures)

      SOURCES
        devtools/infra/jenkins_jobs/servers/templates/helpers/freeze-vms-commit.yaml

      --------------------------------------------------------------------------------

      This job serves as for freezing particular commit based on abstract hg ref.

      This solves 2 problems

      * After some waiting time in queue builds may build not the commit they supposed
        to build, but commit that is assigned to ref by the time build really starts
      * Not all builds are started in the same time, so by the time different builds
        started there are different commits pointed by ref and this is not acceptable

      Frozen commit value (sha) is available in NX_VMS_COMMIT.envvar file represented
      in Jenkins envvar format (Var name, equals and var value not enclosed in quotes).

      To bypass pipeline descriptions from upstream builds there is BUILD_DESCRIPTION
      parameter. A string passed to BUILD_DESCRIPTION will be set as one of the lines
      of build description.

      Every build is connected with upstream builds by Jenkins internals, but due to
      some internal limitations it's recommended to use REQUESTED_BY argument.
      Trigger builds with some unique marker like $JOB_NAME-$BUILD_ID and then query
      latest artifact that has REQUESTED_BY equal to marker.

      --------------------------------------------------------------------------------
      </pre>

    # all build triggers will work under the same workspace as well as
    node: '{hg-local-cache-node}'
    workspace: '{hg-local-cache-node-workspace}'
    concurrent: false

    properties:
    - heavy-job:
        weight: 1
    - throttle:
        option: category
        max-total: 1
        categories:
        - '{hg-local-cache-node-throttle-category}'
    - build-discarder:
        days-to-keep: 30
        num-to-keep: 100
        artifact-days-to-keep: 30
        artifact-num-to-keep: '{default-artifact-num-to-keep}'

    parameters:
    - p_BUILD_DESCRIPTION:
        default: ''
    - p_PIPELINE
    - p_BRANCH
    - p_REQUESTED_BY
    - p_CLEAN_CLONE
    - p_NX_VMS_COMMIT:
        default: ''
    - string:
        name: NX_VMS_COMMIT_VARNAME
        default: NX_VMS_COMMIT
        description: Name of variable to store commit to

    wrappers:
    - timestamps
    - timeout:
        # normally should complete in 2-5 min
        timeout: 20 # min
        fail: true
        type: absolute

    scm:
    - hg-la-no-changelog:
        project-name: nx_vms
        branch-name: '$NX_VMS_COMMIT'
    - hg-la-no-changelog:
        project-name: devtools
        branch-name: default

    builders:
    - inject:
        properties-content: |
          JUNKSHOP_PROJECT_NAME={junkshop_project_name}
    - set-custom-build-description

    - shell: |
        #!/bin/bash
        set -ex
        echo "${{NX_VMS_COMMIT_VARNAME}}=${{MERCURIAL_REVISION_SHORT}}" > "${{NX_VMS_COMMIT_VARNAME}}.envvar"
    - inject:
        properties-file: NX_VMS_COMMIT.envvar

    publishers:
    - publisher-set-build-name:
        name: '#$BUILD_ID $BRANCH@$NX_VMS_COMMIT'
    - archive:
        artifacts: '*.envvar'
        allow-empty: 'false'
        fingerprint: true
    - failure-email-helpers(maintainers):
        email-recipients: '{job-maintainers}'