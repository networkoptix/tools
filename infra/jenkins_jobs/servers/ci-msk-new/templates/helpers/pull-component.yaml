- job-template:
    name: 'helper.pull-component'
    description: |
      <pre>
      ================================================================================
      Pull component
      ================================================================================

      JOB MAINTAINERS
        {job-maintainers}
        (notified by email on build failures)

      SOURCES
        devtools/infra/jenkins_jobs/servers/templates/helpers/pull-component.yaml

      --------------------------------------------------------------------------------

      This job serves for delivering components into particular workspace.

      We have the same jenkins user on each node. But we don't want to mess up with
      permissions and credentials and to find ourselves in situation when artifact
      repo is writeable on nodes where it should be readonly.

      Because of this and few other reasons related to unstable rsync, permissions,
      lack of bash support on windows, etc, we have implemented consuming artifacts in
      "reverse" direction.

      The idea is that job that's being build, schedules another job (this job) to
      deliver all artifacts/components required to build (independently on build type -
      it may be unittesting build or reporting build or something else)

      Build has following parameters

      * Standard stuff related to pipeline, platform and others
      * Target "coordinates" - path on remote host, ssh user and other service data
      * List of components/filters used for filtering only stuff that required

      To bypass pipeline descriptions from upstream builds there is BUILD_DESCRIPTION
      parameter. A string passed to BUILD_DESCRIPTION will be set as one of the lines
      of build description.

      Every build is connected with upstream builds by Jenkins internals, but due to
      some internal limitations it's recommended to use REQUESTED_BY argument.
      Trigger builds with some unique marker like $JOB_NAME-$BUILD_ID and then query
      latest artifact that has REQUESTED_BY equal to marker.

      --------------------------------------------------------------------------------
      </pre>
    node: repository-ops
    concurrent: true

    properties:
    - heavy-job:
        weight: 1
    # this job is heavily used on each pipeline build, so we need large
    # GC timeouts in order to keep all builds for recent pipelines
    - build-discarder:
        days-to-keep: 30
        num-to-keep: 500
        artifact-days-to-keep: 30
        artifact-num-to-keep: 500
    - throttle:
        max-total: 3
        option: project

    parameters:
    - p_REQUESTED_BY
    - p_BUILD_DESCRIPTION:
        default: ''
    # Parameters related to artifact location in repository
    - p_PIPELINE
    - p_BRANCH
    - p_BUILD_IDENTITY
    - p_CUSTOMIZATION
    - p_NX_VMS_COMMIT
    - p_PLATFORM
    - p_COMPONENTS
    # Parameter that defines path to operate it's actually remote path
    - p_LOCAL_PATH
    # Utility parameters used to describe connection details
    - p_NODE_SSH_CONNECTION
    - p_SSH_USER

    wrappers:
    - build-name:
        name: '#$BUILD_ID $BUILD_IDENTITY $BRANCH $PLATFORM $CUSTOMIZATION'
    - timestamps
    - timeout:
        # normally, should complete in 5-10 min
        timeout: 30 # min
        fail: true
        type: absolute
    - ssh-agent-credentials:
        users:
        - jenkins

    builders:
    - inject:
        properties-content: |
          JUNKSHOP_PROJECT_NAME={junkshop_project_name}
    - set-custom-build-description
    - shell: |
        #!/bin/bash
        set -ex
        for var in  REQUESTED_BY    \
                    BRANCH          \
                    PIPELINE        \
                    BUILD_IDENTITY  \
                    CUSTOMIZATION   \
                    COMPONENTS      ; do
          echo "Checking $var to be defined and filled correctly; value is ${{!var}}"
          test "${{!var}}" != '$'"${{var}}" # ~ "$REQUESTED_BY" != '$REQUESTED_BY'
          test "${{!var}}" != ''            # ~ "$REQUESTED_BY" != ''
        done
    - inject:
        properties-content: |
          REPOSITORY_PATH={artifact_repository_base_path}/{artifact_location_full_pattern}
          JUNKSHOP_URL={junkshop_base_url}/{junkshop_location_root_pattern}
          REPOSITORY_URL={artifact_repository_base_url}/{artifact_location_full_pattern}

    - rsync-upload:
        host: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 3)'
        port: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 4)'
        user: '${{SSH_USER}}'
        src_path: '${{REPOSITORY_PATH}}'
        dst_path: '${{LOCAL_PATH}}'
        components: '${{COMPONENTS}}'

    publishers:
    - archive:
        artifacts: RSYNC_FILES_LIST.txt
        allow-empty: 'false'
        fingerprint: true
    - description-setter:
        description: >-
          <a href='$REPOSITORY_URL'> Artifacts </a>,
          <a href='{junkshop_base_url}/{junkshop_location_root_pattern}'> Junkshop </a>
    - failure-email-helpers(maintainers):
        email-recipients: '{job-maintainers}'