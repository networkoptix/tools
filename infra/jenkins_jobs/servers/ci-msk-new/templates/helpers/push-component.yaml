- job-template:
    name: 'helper.push-component'

    node: repository-ops
    concurrent: false  # important

    properties:
    - heavy-job:
        weight: 1
    - throttle:
        max-total: 1
        option: project
    # this job is heavily used on each pipeline build, so we need large
    # GC timeouts in order to keep all builds for recent pipelines
    - build-discarder:
        days-to-keep: 30
        num-to-keep: 500
        artifact-days-to-keep: 30
        artifact-num-to-keep: 500

    parameters:
    - p_REQUESTED_BY
    - p_BUILD_DESCRIPTION:
        default: ''
    # Parameters related to artifact location in repository
    - p_PIPELINE
    - p_BRANCH
    - p_BUILD_IDENTITY
    - p_PLATFORM
    - p_CUSTOMIZATION
    - p_COMPONENTS
    # Parameter that defines path to operate it's actually remote path
    - p_LOCAL_PATH
    # Utility parameters used to describe connection details
    - p_NODE_SSH_CONNECTION
    - p_SSH_USER

    - administrative-section-separator
    - string:
        name: FORCE_PUSH
        default: 'false'
        description: "Delete existing artifacts before pushing."

    wrappers:
    - build-name:
        name: '#$BUILD_ID $BUILD_IDENTITY $BRANCH $PLATFORM $CUSTOMIZATION'
    - timestamps
    - timeout:
        # normally, should complete in 2-10 min
        timeout: 30 # min
        fail: true
        type: absolute
    - ssh-agent-credentials:
        users:
        - jenkins

    builders:
    - inject:
        properties-content: |
          JUNKSHOP_PROJECT_NAME={junkshop_project_name}
    - set-custom-build-description
    - shell: |
        #!/bin/bash
        set -ex
        for var in  REQUESTED_BY    \
                    BRANCH          \
                    PIPELINE        \
                    BUILD_IDENTITY  \
                    CUSTOMIZATION   \
                    COMPONENTS      ; do
          echo "Checking $var to be defined and filled correctly; value is ${{!var}}"
          test "${{!var}}" != '$'"${{var}}" # ~ "$REQUESTED_BY" != '$REQUESTED_BY'
          test "${{!var}}" != ''            # ~ "$REQUESTED_BY" != ''
        done
    - inject:
        properties-content: |
          REPOSITORY_PATH={artifact_repository_base_path}/{artifact_location_full_pattern}
          REPOSITORY_ROOT_PATH={artifact_repository_base_path}/{artifact_location_root_pattern}
          REPOSITORY_URL={artifact_repository_base_url}/{artifact_location_full_pattern}

    - rsync-download:
        host: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 3)'
        port: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 4)'
        user: '${{SSH_USER}}'
        src_path: '${{LOCAL_PATH}}'
        dst_path: '${{REPOSITORY_PATH}}'
        components: '${{COMPONENTS}}'
        force: '$FORCE_PUSH'
        allow_missing: 'YES'
    - shell:  !include-raw-escape: ../../builders/organize_repo.sh

    publishers:
    - description-setter:
        description: >-
          <a href='$REPOSITORY_URL'> Artifacts </a>,
          <a href='{junkshop_base_url}/{junkshop_location_root_pattern}'> Junkshop </a>
    - failure-email-helpers(maintainers):
        email-recipients: '{job-maintainers}'