- job-template:
    name: '{pipeline}.helper.{version}.repo-dedupe'

    node: repository-ops
    concurrent: false

    num_rand_choice: 5

    properties:
    - authorization-{pipeline}-system
    - build-discarder:
        days-to-keep: 10
        num-to-keep: 25
        artifact-days-to-keep: 10
        artifact-num-to-keep: '{default_artifact_num_to_keep}'

    wrappers:
    - timestamps
    - timeout:
        timeout: 360 # 6hr
        fail: true
        type: absolute

    parameters:
    - p_BRANCH:
        default: '{default_branch}'
    - string:
        name: DEDUPE_FOLDERS
        default: ''
        description: >
          List of build identities where to search for common dupes, keep empty to
          pick random folders
    - bool:
        name: DRY_RUN
        default: false
        description: >
          Don't dedupe, just check possible outcome
    - string:
        name: NUM_RAND_CHOICE
        default: '{num_rand_choice}'
        description:
          How many random folders to take if List of folders is not provided
    - p_PIPELINE(hidden):
        default: '{pipeline}'

    builders:
    - inject:
        properties-content: |
          JUNKSHOP_URL={junkshop_base_url}/project/{junkshop_project_name}/$BRANCH/$BUILD_IDENTITY
    # FIXME: this job relies on hardlink utility which is not installed with ansible yet
    - shell: |
        #!/bin/bash
        set -ex

        cd "/mnt/beta-builds/repository/v1/${{PIPELINE}}/${{BRANCH}}"
        if [ -z "$DEDUPE_FOLDERS" ] ; then
          DEDUPE_FOLDERS="$(ls | shuf -n "${{NUM_RAND_CHOICE}}")"
        fi

        if [ "${{DRY_RUN}}" == 'true' ] ; then
          hardlink --dry-run -v -t ${{DEDUPE_FOLDERS}}
        else
          hardlink -v -t ${{DEDUPE_FOLDERS}}
        fi

    publishers:
    - failure-email-helpers(maintainers):
        email-recipients: '{job_maintainers}'
