- job-template:
    name: '{pipeline}.build-reporter'

    node: unittests-reporter
    concurrent: true

    junk_shop_host: 10.0.0.160 # TODO: switch to '10.0.2.101' or parameterize

    parameters:
    - p_CLEAN_CLONE
    - p_BRANCH
    - p_NX_VMS_COMMIT
    - p_BUILD_IDENTITY
    - p_CUSTOMIZATION
    - p_PLATFORM
    - string:
        name: LOGFILE
        description: |
          Logfile that contains information about build
    - string:
        name: BUILD_STATUS
        description: |
          Build status to report, note that THIS ENUM DOES NOT CONFORM with JENKINS ENUMs, valid options are "passed" and "failed"

    wrappers:
    - build-name:
        name: '[${{BUILD_ID}}] ${{BRANCH}}-${{BUILD_IDENTITY}}@${{NX_VMS_COMMIT}}'
    - timestamps
    - timeout:
        timeout: 20 # min
        fail: true
        type: absolute
    # - workspace-cleanup
    - credentials-binding:
      - username-password:
          credential-id: junk_shop_db
          variable: junk_shop_db_credentials
    - copy-hg-repo(2):
        name_1: nx_vms
        name_2: devtools

    scm:
    - hg-la:
        project-name: devtools
        branch-name: default
    - hg-la:
        project-name: nx_vms
        branch-name: $NX_VMS_COMMIT

    builders:

    - trigger-builds:
      - project: 'helper.pull-component'
        predefined-parameters: |
          BUILD_IDENTITY=$BUILD_IDENTITY
          SSH_USER=$USER
          LOCAL_PATH=$WORKSPACE/
          PLATFORM=$PLATFORM
          CUSTOMIZATION=$CUSTOMIZATION
          COMPONENTS=$LOGFILE
          NODE_SSH_CONNECTION=$SSH_CONNECTION
        block: true
        block-thresholds:
          failure-threshold: FAILURE

    - init-venv-linux:
        requirements-files: devtools/ci/junk_shop/requirements.txt
    - shell: |
        #!/bin/bash
        set -ex

        source venv/bin/activate
          export PYTHONPATH=$WORKSPACE/devtools/ci/junk_shop

          DB_CONFIG=$junk_shop_db_credentials@{junk_shop_host}
          REVISION="$(cd nx_vms && hg id --id)"

          # register build
          BUILD_PARAMETERS="project=testing,branch=$BRANCH,build_num=$BUILD_IDENTITY,platform=$PLATFORM,jenkins_url=$JOB_URL,repository_url=ssh://hg@hdw.mx/nx_vms,revision=$REVISION"
          devtools/ci/junk_shop/junk_shop/save_build_info.py "$DB_CONFIG" "$BUILD_PARAMETERS" nx_vms

          # upload build results
          BUILD_PARAMETERS="project=testing,branch=$BRANCH,build_num=$BUILD_IDENTITY,customization=$CUSTOMIZATION,platform=$PLATFORM"
          devtools/ci/junk_shop/junk_shop/build.py "$DB_CONFIG" "$BUILD_PARAMETERS" "$LOGFILE" "--outcome=$BUILD_STATUS"
