- job-template:
    name: '{pipeline}.{branch}.vms.webadmin.universal.build'
    project-type: multijob
    description: |
      <h2> Build webadmin which is a part of nx_vms repository. </h2>

      <p>
        Technically it's linux project. But since it's cross-platform and
        included into any distribution it's built solely.
        And then it's consumed by installers.

      <p>
        This job consumes few groups of parameters.
      <p>
        Parameters related to workspace cleaning logic
        CLEAN_WORKSPACE, CLEAN_CLONE and CLEAN_BUILD.
      <p>
        Parameters related to pointing artifacts in repository and development process
        BUILD_IDENTITY (that determines release id or build_number used for releases) and
        NX_VMS_COMMIT exact commit of sources taht produced this build.

    node: '{webadmin-build-node}'
    concurrent: true

    properties:
    - heavy-job:
        weight: 1
    - throttle:
        max-total: 10
        option: project
    - build-discarder:
        days-to-keep: 30
        num-to-keep: 100
        artifact-days-to-keep: 30
        artifact-num-to-keep: 100

    parameters:
    - p_BUILD_DESCRIPTION:
        default: ''
    - p_CLEAN_WORKSPACE
    - p_CLEAN_CLONE
    - p_CLEAN_BUILD:
        default: false
    - p_BUILD_IDENTITY
    - p_NX_VMS_COMMIT:
        default: '{branch}'

    wrappers:
    - inject:
        properties-content: |
          BRANCH={branch}
          PIPELINE={pipeline}
          PLATFORM=universal
          CUSTOMIZATION=default
    - timestamps
    - timeout:
        # normally, should complete in 7-15 min
        timeout: 30 # min
        fail: true
        type: absolute
    - workspace-cleanup:
        check-parameter: CLEAN_WORKSPACE
    - pre-scm-buildstep:
        failOnError: true
        buildsteps:
        - copy-hg-repo:
            name: nx_vms
        - copy-hg-repo:
            name: devtools

    scm:
    - '{hg-pull-macro}':
        project-name: devtools
        branch-name: default
    - '{hg-pull-macro}':
        project-name: nx_vms
        branch-name: $NX_VMS_COMMIT

    builders:
    - build-name-setter:
        template: '#$BUILD_ID $BRANCH-$BUILD_IDENTITY@$NX_VMS_COMMIT'
        macro: true

    - description-setter:
        description: |
          $BUILD_DESCRIPTION
    - inject:
        properties-content: |
          REPOSITORY_URL={artifact_repository_base_url}/{artifact_location_full_pattern}
          JUNKSHOP_URL={junkshop_base_url}/{junkshop_location_root_pattern}
    - description-setter:
        description: >-
          <a href='$REPOSITORY_URL'> Artifacts </a>,
          <a href='$JUNKSHOP_URL'> Junkshop </a>

    - conditionally-clean-dir:
        condition-varname: CLEAN_BUILD
        dir: build

    - file-delete-operation:
        includes: webadmin-build.log
        excludes: ''

    - run-process:
        workdir: $WORKSPACE
        executable: nx_vms/webadmin/build.sh
        executable-is-relpath: 'true'
        arguments: ''
        logfile: webadmin-build.log
        inherit-environ: 'true'
        environ: ''

    publishers:
    - archive:
        artifacts: webadmin-build.log, static/version.txt
        allow-empty: 'false'
        fingerprint: true

    # TODO: publish into other repo than default when build is failed
    - postbuildscript:
        mark-unstable-if-failed: true
        builders:
        - role: SLAVE
          build-on:
          - SUCCESS
          - UNSTABLE
          - FAILURE
          - NOT_BUILT
          - ABORTED
          build-steps:
          - trigger-builds:
            - project: 'helper.push-component'
              block: true
              block-thresholds:
                failure-threshold: FAILURE
              predefined-parameters: |
                BUILD_IDENTITY=$BUILD_IDENTITY
                PLATFORM=$PLATFORM
                CUSTOMIZATION=$CUSTOMIZATION
                LOCAL_PATH=$WORKSPACE/
                COMPONENTS=server-external/,webadmin-build.log,static/version.txt
                NODE_SSH_CONNECTION=$SSH_CONNECTION
                SSH_USER=$USER
    - postbuildscript:
        mark-unstable-if-failed: true
        builders:
        - role: SLAVE
          build-on:
          - SUCCESS
          build-steps:
          - trigger-builds:
            - project: '{pipeline}.build-reporter'
              # block: true
              predefined-parameters: |
                BRANCH=$BRANCH
                NX_VMS_COMMIT=$NX_VMS_COMMIT
                BUILD_IDENTITY=$BUILD_IDENTITY
                PLATFORM=$PLATFORM
                CUSTOMIZATION=$CUSTOMIZATION
                BUILD_STATUS=passed
                LOGFILE=webadmin-build.log

    - postbuildscript:
        mark-unstable-if-failed: true
        builders:
        - role: SLAVE
          build-on:
          - FAILURE
          build-steps:
          - trigger-builds:
            - project: '{pipeline}.build-reporter'
              # block: true
              predefined-parameters: |
                BRANCH=$BRANCH
                NX_VMS_COMMIT=$NX_VMS_COMMIT
                BUILD_IDENTITY=$BUILD_IDENTITY
                PLATFORM=$PLATFORM
                CUSTOMIZATION=$CUSTOMIZATION
                BUILD_STATUS=failed
                LOGFILE=webadmin-build.log

    - failure-email:
        email-recipients: '{build-watchers}'
    - fixed-email:
        email-recipients: '{build-watchers}'