- job-template:
    name: '{pipeline}.helper.promote-build'
    id: helpers/promote-build

    description: |
      <pre>
      ================================================================================
      Build Promotion
      ================================================================================

      Create symlinks to beta-builds/daily, so build files will be accessible
      for DepCon.

      </pre>

    node: repository-ops
    concurrent: false

    parameters:
    - p_BUILD_DESCRIPTION:
        default: ''
    - p_BRANCH
    - p_NX_VMS_COMMIT
    - p_BUILD_IDENTITY
    - p_PIPELINE(hidden):
        default: '{pipeline}'

    wrappers:
    - timestamps
    - timeout:
        timeout: 20 # min
        fail: true
        type: absolute

    builders:
    - decorators/set-custom-build-description
    - build-name-setter:
        template: '#$BUILD_ID $BRANCH-$BUILD_IDENTITY@$NX_VMS_COMMIT'
        macro: true
    - repository/promote-to-daily:
        artifact_repository_base_path: '{artifact_repository_base_path}'
        # platform dir name mapping: repository -> daily builds
        platform_map:
          __common:
            distributive_mask_list:
            - 'eula-*.html'
          linux-x64:
            publish_dir: linux
            distributive_mask_list:
            - '*.deb'
            - '*-testcamera-*'
            update_mask_list:
            - '*_update-*.zip'
          linux-x86:
            publish_dir: linux
            distributive_mask_list:
            - '*.deb'
            - '*-testcamera-*'
            update_mask_list:
            - '*_update-*.zip'
          windows-x64:
            publish_dir: windows
            distributive_mask_list:
            - '*.exe'
            - '*-testcamera-*.zip'
            update_mask_list:
            - '*_update-*.zip'
            - '*_debug-*.zip'  # strange, but pdbs go to updates dir
          windows-x86:
            publish_dir: windows
            distributive_mask_list:
            - '*.exe'
            - '*-testcamera-*.zip'
            update_mask_list:
            - '*_update-*.zip'
            - '*_debug-*.zip'  # strange, but pdbs go to updates dir
          mac:
            publish_dir: macos
            distributive_mask_list:
            - '*.dmg'
            update_mask_list:
            - '*_update-*.zip'
          ios:
            publish_dir: ios
            distributive_mask_list:
            - '*.ipa'
            update_mask_list: []
          android-arm:
            publish_dir: android
            distributive_mask_list:
            - '*.apk'
            update_mask_list: []
          bananapi:
            publish_dir: arm
            distributive_mask_list:
            - '*.zip'
            update_mask_list:
            - '*_update-*.zip'
          bpi:
            publish_dir: arm
            distributive_mask_list:
            - '*.zip'
            update_mask_list:
            - '*_update-*.zip'
          rpi:
            publish_dir: arm
            distributive_mask_list:
            - '*.zip'
            update_mask_list:
            - '*_update-*.zip'
          edge1:
            publish_dir: arm
            distributive_mask_list:
            - '*.zip'
            update_mask_list:
            - '*_update-*.zip'
          tx1:
            publish_dir: arm
            distributive_mask_list:
            - '*.tgz'
            - '*.zip'
            update_mask_list: []

    publishers:
    - failure-email-helpers(maintainers):
        email-recipients: '{job_maintainers}'
