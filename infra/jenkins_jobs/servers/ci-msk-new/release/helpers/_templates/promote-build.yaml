- job-template:
    name: '{pipeline}.helper.promote-build'
    id: helpers/promote-build

    description: |
      <pre>
      ================================================================================
      Build Promotion
      ================================================================================

      Create symlinks to beta-builds/daily, so build files will be accessible
      for DepCon.

      </pre>

    node: repository-ops
    concurrent: false

    parameters:
    - p_BUILD_DESCRIPTION:
        default: ''
    - p_BRANCH
    - p_NX_VMS_COMMIT
    - p_BUILD_IDENTITY
    - p_PIPELINE(hidden):
        default: '{pipeline}'

    wrappers:
    - timestamps
    - timeout:
        timeout: 20 # min
        fail: true
        type: absolute

    builders:
    - decorators/set-custom-build-description
    - build-name-setter:
        template: '#$BUILD_ID $BRANCH-$BUILD_IDENTITY@$NX_VMS_COMMIT'
        macro: true
    - repository/promote-to-daily:
        artifact_repository_base_path: '{artifact_repository_base_path}'
        artifacts_to_daily_mappings:

        - src: linux-x64
          dst: updates/$BUILD_IDENTITY
          masks:
          - '*_update-*.zip'
        - src: linux-x64
          dst: linux
          masks:
          - '*.deb'
          - '*-testcamera-*'
          - 'eula-*.html'

        - src: linux-x86
          dst: updates/$BUILD_IDENTITY
          masks:
          - '*_update-*.zip'
        - src: linux-x86
          dst: linux
          masks:
          - '*.deb'
          - '*-testcamera-*'
          - 'eula-*.html'

        - src: windows-x64
          dst: updates/$BUILD_IDENTITY
          masks:
          - '*_update-*.zip'
          - '*_debug-*.zip'  # strange, but pdbs go to updates dir
        - src: windows-x64
          dst: windows
          masks:
          - '*.exe'
          - '*-testcamera-*.zip'
          - 'eula-*.html'

        - src: windows-x86
          dst: updates/$BUILD_IDENTITY
          masks:
          - '*_update-*.zip'
          - '*_debug-*.zip'  # strange, but pdbs go to updates dir
        - src: windows-x86
          dst: windows
          masks:
          - '*.exe'
          - '*-testcamera-*.zip'
          - 'eula-*.html'

        - src: mac
          dst: updates/$BUILD_IDENTITY
          masks:
          - '*_update-*.zip'
        - src: mac
          dst: macos
          masks:
          - '*.dmg'
          - 'eula-*.html'

        - src: ios
          dst: ios
          masks:
          - '*.ipa'
          - 'eula-*.html'

        - src: android-arm
          dst: android
          masks:
          - '*.apk'
          - 'eula-*.html'

        - src: bananapi
          dst: updates/$BUILD_IDENTITY
          masks:
          - '*_update-*.zip'
        - src: bananapi
          dst: arm
          masks:
          - '*.zip'
          - 'eula-*.html'

        - src: bpi
          dst: updates/$BUILD_IDENTITY
          masks:
          - '*_update-*.zip'
        - src: bpi
          dst: arm
          masks:
          - '*.zip'
          - 'eula-*.html'

        - src: rpi
          dst: updates/$BUILD_IDENTITY
          masks:
          - '*_update-*.zip'
        - src: rpi
          dst: arm
          masks:
          - '*.zip'
          - 'eula-*.html'

        - src: edge1
          dst: updates/$BUILD_IDENTITY
          masks:
          - '*_update-*.zip'
        - src: edge1
          dst: arm
          masks:
          - '*.zip'
          - 'eula-*.html'

        - src: tx1
          dst: arm
          masks:
          - '*.tgz'
          - '*.zip'
          - 'eula-*.html'

    publishers:
    - archive:
        artifacts: '*.txt'
    - failure-email-helpers(maintainers):
        email-recipients: '{job_maintainers}'
