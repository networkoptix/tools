- project:
    name: release-pipeline

    # IMPORTANT NOTE: need to define in jenkins tools config section
    # We may probably replace that groovy incl groovy w/ python.
    groovy-version: groovy
    project: vms

    branch:
    - vms_3.2

    # SECTION. GLOBAL CONFIG
    # ============================================================

    # location of repository whre to publish builds
    artifact_repository_base: '/mnt-stub/beta-builds/repository/v1'  # TODO: switch to /mnt/beta-builds
    # location of folder where mercurial repos are precached
    # this cache is required due to the fact that mercurial can't
    # fetch part of repo and always pulls everything (~3GB over atlantic)
    cached_hg_repository_base: '/mnt-stub/infra/cached-hg'  # TODO: switch to /mnt/infra

    webadmin-build-node: webadmin-build
    commit-freeze-node: webadmin-build

    # We use some trick to reuse precompiled obj files.
    # Dirty builds run faster than clean and we are trying to optimize build speed.
    #
    # Given axes:
    #  platform         linux-64, linux-86, windows-86, ..
    #  branch           default, vms, vms_3.2, ..
    #  customization    default, hanwha, ..
    #
    # Optimization rules:
    #  changing platform       -> full rebuild
    #  changing branch         -> full rebuild (looks like)
    #  changing customization  -> partial rebuild
    #
    # The solution is:
    # 1. Keep platform x branch in separate workspaces
    # 2. Allow to build different customization in the same place
    # 3. Mess-up auto, release and custom pipelines into the same workspace (this may result in
    #    full rebuild in future, but anyways we may control build time and see this problem)
    #
    # Job specific:
    # According to prev. facts,
    # - all platform x branch variables are frozen in job
    # - all customization-related stuff is passed as arguments
    workspace: nx_build_thr${{EXECUTOR_NUMBER}}_{pipeline}_{platform}/

    # in some cases there is a "cleaner" script that does some actions inbetween dirty builds.
    # this path is optional but if it exists, cleaner will be invoked
    custom_cleaner_path: $WORKSPACE/nx_vms/build_utils/python/clear_cmake_build.py

    # Some cmake args are applicable for any builds they are applied at first
    cmake_configure_args_global: |
      CMAKE_EXECUTABLE=cmake
      CMAKE_ARG_beta=TRUE
      CMAKE_ARG_developerBuild=OFF
      CMAKE_ARG_cloudGroup=test
      CMAKE_ARG_withTests=TRUE
      CMAKE_ARG_addQtPdb=TRUE

    # SECTION. PIPELINE CONFIG
    # ============================================================

    pipeline:
    - release:
        # Pipeline-specific cmake arguments
        cmake_configure_args_pipeline:
          CMAKE_ARG_CMAKE_BUILD_TYPE=Release

    # SECTION. PLATFORM CONFIG
    # ============================================================

    platform:
    # there is also edge1 platform, it's declared and commented in jobs section
    - linux-x64:
        # most of builds are linux cross-builds that built on "build-installer-linux"
        # here we make an anchor to avoid typos and other kind of missconfiguration in future
        installer-build-node: &linux_node build-installer-linux
        # There are some CMake args that aplicable only for particular platform
        cmake_configure_args_platform: |
          CMAKE_GENERATOR=Ninja
    - linux-x86:
        installer-build-node: *linux_node
        cmake_configure_args_platform: |
          CMAKE_GENERATOR=Ninja
          CMAKE_ARG_targetDevice=linux-x86
    - bananapi:
        installer-build-node: *linux_node
        cmake_configure_args_platform: |
          CMAKE_GENERATOR=Ninja
          CMAKE_ARG_targetDevice=bananapi
    # TODO: Enable later when we'll be ready to test it.
    #
    # - bpi:
    #     installer-build-node: *linux_node
    #     cmake_configure_args_platform: |
    #       CMAKE_GENERATOR=Ninja
    #       CMAKE_ARG_targetDevice=bpi
    # - rpi:
    #     installer-build-node: *linux_node
    #     cmake_configure_args_platform: |
    #       CMAKE_GENERATOR=Ninja
    #       CMAKE_ARG_targetDevice=rpi
    # - tx1:
    #     installer-build-node: *linux_node
    #     cmake_configure_args_platform: |
    #       CMAKE_GENERATOR=Ninja
    #       CMAKE_ARG_targetDevice=tx1
    - android-arm:
        installer-build-node: *linux_node
        cmake_configure_args_platform: |
          CMAKE_GENERATOR=Ninja
          CMAKE_ARG_targetDevice=android-arm

    # -- windows platform --
    # FIXME: HOME,PATH and other vars are represented as win env.
    # But some other vars are linux-like.
    # Rsync goes mad ain result and nothing works.
    - win-x64: &windows_config
        installer-build-node: build-installer-windows
        cmake_configure_args_platform: |
          CMAKE_EXECUTABLE=C:\Program files\CMake\bin\cmake.exe
          CMAKE_GENERATOR=Visual Studio 15 2017 Win64
          CMAKE_TOOL=host=x64
    - win-x86:
        <<: *windows_config
        cmake_configure_args_platform: |
          CMAKE_EXECUTABLE=C:\Program files\CMake\bin\cmake.exe
          CMAKE_GENERATOR=Visual Studio 15 2017
          CMAKE_TOOL=host=x64

    # -- apple platform --

    # TODO: Enable later when we'll be ready to test it.
    #
    # - mac: &osx_config
    #     installer-build-node: build-installer-mac
    #     cmake_configure_args_platform: |
    #       CMAKE_GENERATOR=Ninja
    # - ios:
    #     <<: *osx_config
    #     installer-build-node:
    #     cmake_configure_args_platform: |
    #       CMAKE_GENERATOR=Xcode
    #       CMAKE_ARG_targetDevice=ios

    # SECTION. CUSTOMIZATION CONFIG
    # ============================================================

    # TODO: There are some customization that may be build only on specific platform
    # there is no need to generate extra set of jobs that never gonna be triggered.
    # it looks like there are too few customization spec. cmake args and we may move such
    # rare customizations to platform enum.

    cmake_configure_args_customization: |
      CMAKE_ARG_customization=$CUSTOMIZATION

    customization:

    # TODO: Enable later when we'll be ready to test it.

    - default
    # - default_cn
    # - default_zh_CN
    # - cox
    # - digitalwatchdog
    # - digitalwatchdog_global
    - hanwha
    # - ipera
    # - ionetworks
    # - nutech
    # - ras
    # - senturian
    # - systemk
    # - tricom
    # - ust
    - vista
    # - vmsdemoblue
    # - vmsdemoorange

    # list of jobs to generate
    jobs:

    # HELPERS - syncronize and publish different stuff

    - helper.sync-hg
    - helper.pull-component
    - helper.push-component

    # RUNNER - main entry point

    - '{pipeline}.{branch}.vms.runner':
        counter_name: build_number
        counter_var_name: BUILD_IDENTITY

    # UTILITY - register commit, build identities and other

    - '{pipeline}.{branch}.vms.freeze_nx_vms_commit'
    - '{pipeline}.{counter_name}.generator':
        counter_name: build_number
        counter_var_name: BUILD_IDENTITY

    # BUILD AND TEST - main jobs

    - '{pipeline}.{branch}.vms.webadmin.universal.build'
    - '{pipeline}.{branch}.vms.installer.{platform}.{customization}.all'
    - '{pipeline}.{branch}.vms.installer.{platform}.{customization}.build'
    # Edge1 is a platform that's exclusive for digitalwatchdog.
    # add extra jobs for edge1 with digitalwatchdog customization
    - '{pipeline}.{branch}.vms.installer.{platform}.{customization}.all': &extra-edge1-platform
        platform:
        - edge1:
            installer-build-node: *linux_node
            cmake_configure_args_platform: |
              CMAKE_GENERATOR=Ninja
              CMAKE_ARG_targetDevice=edge1
        customization:
        - 'digitalwatchdog'
    - '{pipeline}.{branch}.vms.installer.{platform}.{customization}.build':
        <<: *extra-edge1-platform

    # Our tests work per-customization per-platform and not yet implemented
    # for all platforms, so list of jobs is reduced
    - '{pipeline}.{branch}.vms.installer.{platform}.{customization}.unittest':
        platform:
        - linux-x64
        customization:
        - default