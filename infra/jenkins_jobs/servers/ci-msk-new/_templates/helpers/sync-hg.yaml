- job-template:
    name: '{pipeline}.helper.sync-hg'

    # all build triggers will work under the same workspace as well as
    node: repo-read
    workspace: 'nx_{pipeline}_hgsync_thr${{EXECUTOR_NUMBER}}'
    concurrent: true

    properties:
    - authorization-{pipeline}-system
    - priority-sorter:
        priority: !j2: '{{ pipeline_priority }}'
    - throttle:
        max-total: 2
        option: project
    - build-discarder:
        days-to-keep: 10
        num-to-keep: 500
        artifact-days-to-keep: 10
        artifact-num-to-keep: 500

    parameters:
    - p_BUILD_DESCRIPTION:
        default: ''
    - p_BRANCH
    - p_PLATFORM
    - p_CUSTOMIZATION
    - string:
        name: REPO
        default: nx_vms
        description: >
          Which hg repo to sync, devtools or nx_vms
    - p_LOCAL_PATH
    - p_NODE_SSH_CONNECTION
    - p_SSH_USER
    - p_NX_VMS_COMMIT:
        default: default

    wrappers:
    - build-name:
        name: '#${{BUILD_ID}}'
    - timestamps
    - timeout:
        # normally, should complete in 2-10 min
        timeout: 30 # min
        fail: true
        type: absolute
    - ssh-agent-credentials:
        users:
        - jenkins

    scm:
    - mercurial/local-mirror-no-changelog:
        name: '$REPO'
        revision: '$NX_VMS_COMMIT'

    builders:
    - decorators/set-custom-build-description
    # - validators/required-params:
    #     params: >-
    #       BRANCH
    #       PLATFORM
    #       CUSTOMIZATION
    #       REPO
    #       LOCAL_PATH
    #       NODE_SSH_CONNECTION
    #       SSH_USER
    - rsync/upload:
        host: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 3)'
        port: '$(echo "${{NODE_SSH_CONNECTION}}" | cut -d " " -f 4)'
        user: '${{SSH_USER}}'
        src_path: '${{WORKSPACE}}/'
        dst_path: '${{LOCAL_PATH}}/'
        components: '${{REPO}}/'

    publishers:
    - failure-email-helpers(maintainers):
        email-recipients: '{job_maintainers}'
