- job-template:
    name: '{pipeline}.helper.build-reporter'
    description: |
      <pre>
      ================================================================================
      Build reporter
      ================================================================================

      JOB MAINTAINERS
        {job_maintainers}
        (notified by email on build failures)

      ONLY FAILED BUILDS MAY BE RETRIGGERED/RETRIED

      If build failed by infrastracture reasons anyone may try to retrigger uploading
      process.

      --------------------------------------------------------------------------------

      This job serves for parsing and uploading build results into JunkShop service.

      To bypass pipeline descriptions from upstream builds there is BUILD_DESCRIPTION
      parameter. A string passed to BUILD_DESCRIPTION will be set as one of the lines
      of build description.

      Every build is connected with upstream builds by Jenkins internals, but due to
      some internal limitations it's recommended to use REQUESTED_BY argument.
      Trigger builds with some unique marker like $JOB_NAME-$BUILD_ID and then query
      latest artifact that has REQUESTED_BY equal to marker.

      Known issues

      - unknown revision '<rev-sha>' - means that branch have 2+ heads and prev build
      is done from other head that's not parent for current.

      --------------------------------------------------------------------------------
      </pre>
    node: reporter
    concurrent: false
    workspace: !j2: '{{ "__debug__" if __debug__ else "" }}{{ pipeline }}-build-reporter'

    properties:
    - authorization-{pipeline}-system
    - priority-sorter:
        priority: !j2: '{{ pipeline_priority }}'
    - throttle:
        max-total: 10
        option: project
    - build-discarder:
        days-to-keep: 10
        num-to-keep: 500
        artifact-days-to-keep: 10
        artifact-num-to-keep: 500

    parameters:
    - p_REQUESTED_BY
    - p_BUILD_DESCRIPTION:
        default: ''
    - p_CLEAN_CLONE
    - p_BRANCH
    - p_BUILD_IDENTITY
    - p_CUSTOMIZATION
    - p_PLATFORM
    - p_NX_VMS_COMMIT
    - p_BUILD_STATUS
    - p_RUNNER_URL
    - p_PIPELINE(hidden):
        default: '{pipeline}'

    wrappers:
    - timestamps
    - timeout:
        timeout: 20 # min
        fail: true
        type: absolute
    - credentials-binding:
      - username-password:
          credential-id: junk_shop_db
          variable: JUNK_SHOP_DB_CREDENTIALS
    - pre-scm-buildstep:
        failOnError: true
        buildsteps:
        - cleaners/custom-clean-workspace:
            keep_files: [ nx_vms, devtools, venv ]
        - mercurial/import-repo-if-missing:
            name: nx_vms
            branch: $BRANCH
            platform: $PLATFORM
            customization: $CUSTOMIZATION
            pipeline: '{pipeline}'
            basedir: $WORKSPACE
        - mercurial/import-repo-if-missing:
            name: devtools
            branch: '{devtools_revision}'
            platform: $PLATFORM
            customization: $CUSTOMIZATION
            pipeline: '{pipeline}'
            basedir: $WORKSPACE

    scm:
    - mercurial/local-mirror-no-changelog:
        name: nx_vms
        revision: '$NX_VMS_COMMIT'
    - mercurial/local-mirror:
        name: devtools
        revision: '{devtools_revision}'

    builders:
    - mercurial/mark-successful-checkout
    - inject:
        properties-content: |
          JUNKSHOP_URL={junkshop_base_url}/project/{junkshop_project_name}/$BRANCH/$BUILD_IDENTITY
          REPOSITORY_URL={artifacts_base_url}/$PIPELINE/$BRANCH/$BUILD_IDENTITY/$CUSTOMIZATION/$PLATFORM
    - decorators/set-custom-build-description
    - build-name-setter:
        template: '#$BUILD_ID $BRANCH-$BUILD_IDENTITY@$NX_VMS_COMMIT'
        macro: true
    - trigger-builds:
      - project: '{pipeline}.helper.pull-component'
        predefined-parameters: |
          REQUESTED_BY=$JOB_NAME-$BUILD_NUMBER
          BUILD_DESCRIPTION=$BUILD_DESCRIPTION
          BRANCH=$BRANCH
          BUILD_IDENTITY=$BUILD_IDENTITY
          PIPELINE=$PIPELINE
          CUSTOMIZATION=$CUSTOMIZATION
          PLATFORM=$PLATFORM
          SSH_USER=$USER
          LOCAL_PATH=$WORKSPACE/
          COMPONENTS=*.log,build_logs/
          NODE_SSH_CONNECTION=$SSH_CONNECTION
        block: true
        block-thresholds:
          failure-threshold: FAILURE

    - shell: |
        #!/bin/bash
        set -ex

        rm -f full_build.log
        touch full_build.log

        for logfile in  webadmin-build.log	                 \
                        build_logs/cleaner.log               \
                        build_logs/cmake-configure-vms.log   \
                        build_logs/ninja_clean.log           \
                        build_logs/cmake-build-vms.log       \
                        build_logs/cmake-configure-paxton*.log \
                        build_logs/cmake-build-paxton*.log ; do
          if [ -f $logfile ] ; then
            cat $logfile >> full_build.log
          fi
        done

        if [ ! -d venv ]; then
          virtualenv --system-site-packages venv
        fi

        source venv/bin/activate
          pip install --upgrade pip setuptools wheel
          pip install --upgrade -r devtools/ci/junk_shop/requirements.txt

          export PYTHONPATH=$WORKSPACE/devtools/ci/junk_shop

          JUNK_SHOP_DB=$JUNK_SHOP_DB_CREDENTIALS@{junkshop_db_host}
          REVISION="$(cd nx_vms && hg id --id)"

          if [ "$PLATFORM" == 'universal' ] ; then
            JUNKSHOP_PLATFORM=webadmin
          else
            JUNKSHOP_PLATFORM="$PLATFORM"
          fi

          # register build
          BUILD_PARAMETERS=(
            "project={junkshop_project_name}"
            "branch=$BRANCH"
            "build_num=$BUILD_IDENTITY"
            "platform=$JUNKSHOP_PLATFORM"
            "jenkins_url=$RUNNER_URL"
            "repository_url=ssh://hg@hdw.mx/nx_vms"
            "revision=$REVISION"
            )

          devtools/ci/junk_shop/junk_shop/save_build_info.py \
            --junk-shop-db="$JUNK_SHOP_DB" \
            --build-parameters "${{BUILD_PARAMETERS[@]}}" \
            -- \
            nx_vms

          # upload build results
          BUILD_PARAMETERS=(
            "project={junkshop_project_name}"
            "branch=$BRANCH"
            "build_num=$BUILD_IDENTITY"
            "customization=$CUSTOMIZATION"
            "platform=$JUNKSHOP_PLATFORM"
            )

          devtools/ci/junk_shop/junk_shop/build.py \
            --junk-shop-db="$JUNK_SHOP_DB" \
            --build-parameters "${{BUILD_PARAMETERS[@]}}" \
            "--outcome=$BUILD_STATUS" \
            full_build.log

    publishers:
    - mercurial/rm-repo-if-broken
    - cleaners/custom-clean-workspace:
        keep_files: [ nx_vms, devtools, venv ]
    - description-setter:
        description: >-
          <a href='$REPOSITORY_URL'> Artifacts </a>,
          <a href='$JUNKSHOP_URL'> Junkshop </a>
    - failure-email-helpers(maintainers):
        email-recipients: '{job_maintainers}'
