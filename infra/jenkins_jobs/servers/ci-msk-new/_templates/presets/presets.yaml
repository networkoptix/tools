- job-template: &preset
    name: '{pipeline}.{version}.preset.{preset-name}'
    id: 'preset'

    description: !j2: |
      <pre>
      ================================================================================
      Build Preset
      ================================================================================

      JOB MAINTAINERS
        {{ job_maintainers | default ("") }}

      --------------------------------------------------------------------------------

      This job serves for starting bunch of builds associated with particular commit
      in nx_vms repository and also assigned build identity.

      {{ detailed_job_description | default("") }}

      </pre>

    node: runner
    concurrent: true

    timer: ''  # no timed trigger by default

    properties:
    - !j2: authorization-{{ pipeline }}-{{ auth_kind | default("trigger") }}

    - throttle:
        max-total: !j2: '{{ max_concurrent_presets | default (3) }}'
        option: project

    parameters:

    - p_BRANCH:
        default: '{default_branch}'
    - p_BUILD_DESCRIPTION:
        default: !j2: '{{ build_description | default("Triggered manually") }}'

    - parameter-separator/simple-colored:
        header: 'Options for VMS'
        color: lavender
    - p_VMS_BUILD_CHOICE_w_OPTION:
        default: '{vms_build_choice_default}'
        option_default: '{vms_build_choice_option_default}'
    # - better-single-select:
    #     name: VMS_BUILD_FROM_PIPELINE
    #     choices:
    #     - [ debug,   "Debug - Jenkins testing" ]
    #     - [ develop, "Development - CI and nightly builds" ]
    #     - [ custom,  "Custom - feature testing" ]
    #     - [ release, "Release - builds intended to be published" ]
    #     default: '{pipeline}'
    # TODO: Separate allowed_choices and default on project level
    - p_PLATFORMS:
        allowed_choices: !j2: '{{ default_platforms | default("") }}'
        default: !j2: '{{ default_platforms | default("") }}'
    - p_CUSTOMIZATIONS:
        allowed_choices: !j2: '{{ default_customizations | default("") }}'
        default: !j2: '{{ default_customizations | default("") }}'

    - p_CLOUD_GROUP:
        default: test
    - p_BETA:
        default: !j2: '{{ beta | default("ON") }}'
    - p_CODE_SIGNING:
        default: 'OFF'
    - p_TRUSTED_TIMESTAMPING:
        default: 'OFF'
    - p_CUSTOM_CMAKE_PARAMETERS:
        default: !j2: '{{ custom_cmake_parameters | default("") }}'

    - parameter-separator/simple-colored:
        header: 'Options for Unittests'
        color: lavender
    - on-off-option:
        name: UT_ENABLED
        description: If ON, then UnitTests will run, otherwise skipped
        default: '{ut_enabled}'

    - parameter-separator/simple-colored:
        header: 'Options for Functional tests'
        color: lavender

    - on-off-option:
        name: FT_ENABLED
        subject: If ON, then FuncTests will run, otherwise skipped
        default: '{ft_enabled}'
    - p_FT_COMMIT_CHOICE_w_OPTION:
        default: '{ft_commit_choice_default}'
        option_default: '{ft_commit_choice_option_default}'
    - p_TEST_SELECT_EXPR:
        default: !j2: '{{ test_select_expr | default("") }}'
    - p_TEST_LIST:
        default: !j2: '{{ test_list | default("") }}'

    - parameter-separator/simple-colored:
        header: 'Options for Real cameras tests'
        color: lavender
    - on-off-option:
        name: RCT_ENABLED
        subject: If ON, then RealCameraTests will run, otherwise skipped
        default: '{rct_enabled}'
    - p_RCT_COMMIT_CHOICE_w_OPTION:
        default: '{rct_commit_choice_default}'
        option_default: '{rct_commit_choice_option_default}'
    - p_RCT_CAMERA_FILTER:
        name: RCT_CAMERA_FILTER
        default:  !j2: '{{ rct_camera_filter | default("*") }}'

    - parameter-separator/simple-colored:
        header: 'Options for Scalability tests'
        color: lavender
    - on-off-option:
        name: ST_ENABLED
        subject: If ON, then SacalbilityTests will run, otherwise skipped
        default: '{st_enabled}'
    - p_ST_SCENARIOS:
        default: !j2: '{{ st_scenarios | default("lws-50,lws-100,lws-150,lws-200,lws-250,lws-300,full-50,full-100,full-150,full-200") }}'
    - p_ST_COMMIT_CHOICE_w_OPTION:
        default: !j2: '{{ st_commit_choice_default | default("ST_LATEST") }}'
        option_default: !j2: '{{ st_commit_choice_option_default | default("") }}'
    - hidden:
        name: CANCEL_IN_FAV_OF_NEWER_BUILD
        default: !j2: '{{ cancel_in_fav_of_newer_build | default("false") }}'
    - hidden:
        name: RUN_KIND
        default: !j2: '{{run_kind | default(default_run_kind) }}'

    # TODO: Add additional sections and options...
    # - parameter-separator/simple-colored:
    #     header: 'Extra options'
    #     color: lavender
    # - string:
    #     name: EMAIL_NOTIFY_CC
    #     default: ''
    #     description: Add reciepients for email notification. You will receive email anyways.

    triggers:
    - timed: "{timer}"

    wrappers:
    - timestamps

    builders:
    - cleaners/custom-clean-workspace:
        keep_files: [ devtools, nx_vms ]
    - decorators/set-custom-build-description
    - queue/cancel-if-queued-newer
    - trigger-builds:
      - project: '__{pipeline}.{version}.param-resolver'
        block: true
        current-parameters: true
        predefined-parameters: |
          REQUESTED_BY=$JOB_NAME-$BUILD_NUMBER
    - copyartifact:
        project: '__{pipeline}.{version}.param-resolver'
        filter: 'RUNNER_ARGS.envvars'
        which-build: last-completed
        parameter-filters: REQUESTED_BY=$JOB_NAME-$BUILD_NUMBER
    - shell: cat RUNNER_ARGS.envvars
    - inject:
        properties-file: 'RUNNER_ARGS.envvars'
    - shell: |
        #!bash
        echo "BUILD_IDENTITY=$BUILD_IDENTITY" >> BUILD_IDENTITY.envvar
        # TODO: Change these argnames!!!
        echo "NX_VMS_COMMIT=$NX_VMS_COMMIT" >> NX_VMS_COMMIT.envvar
        echo "NX_FUNCTESTS_COMMIT=$NX_FUNCTESTS_COMMIT" > NX_FUNCTESTS_COMMIT.envvar
        echo "NX_VMS_REAL_CAMERA_TEST_FRAMEWORK_COMMIT=$NX_VMS_REAL_CAMERA_TEST_FRAMEWORK_COMMIT" >> NX_VMS_REAL_CAMERA_TEST_FRAMEWORK_COMMIT.envvar
        echo "ST_COMMIT=$ST_COMMIT" >> ST_COMMIT.envvar
    - build-name-setter:
        template: '#$BUILD_ID $BRANCH-$BUILD_IDENTITY@$NX_VMS_COMMIT'
        # TODO: add after some args will be stored in resolver even when tests are disabled.
        # FT@$NX_FUNCTESTS_COMMIT RCT@$NX_VMS_REAL_CAMERA_TEST_FRAMEWORK_COMMIT ST@$ST_COMMIT'
        macro: true
    - trigger-builds:
      - project: '{pipeline}.{version}.vms.runner'
        block: true
        property-file: RUNNER_ARGS.envvars
        predefined-parameters: !j2: |
          REQUESTED_BY=$JOB_NAME-$BUILD_NUMBER
          UPSTREAM_JOB_NAME=$JOB_NAME
          BUILD_DESCRIPTION=$BUILD_DESCRIPTION
          RUN_KIND=$RUN_KIND

    publishers:
    - archive:
        artifacts: '*.envvars'
        allow-empty: 'false'
        fingerprint: true
    - archive:
        artifacts: '*.envvar'
        allow-empty: 'false'
        fingerprint: true


- job-template:
    <<: *preset
    id: preset-build-only
    parameters:

    - p_BRANCH(hidden):
        default: '{default_branch}'
    - p_BUILD_DESCRIPTION:
        default: !j2: '{{ build_description | default("Triggered manually") }}'

    - parameter-separator/simple-colored:
        header: 'Options for VMS'
        color: lavender
    - p_VMS_BUILD_CHOICE_w_OPTION:
        default: '{vms_build_choice_default}'
        option_default: '{vms_build_choice_option_default}'
    - p_PLATFORMS:
        allowed_choices: !j2: '{{ default_platforms | default("") }}'
        default: !j2: '{{ default_platforms | default("") }}'
    - p_CUSTOMIZATIONS:
        allowed_choices: !j2: '{{ default_customizations | default("") }}'
        default: !j2: '{{ default_customizations | default("") }}'

    - p_CLOUD_GROUP:
        default: test
    - p_BETA:
        default: !j2: '{{ beta | default("ON") }}'
    - p_CODE_SIGNING:
        default: 'OFF'
    - p_TRUSTED_TIMESTAMPING:
        default: 'OFF'
    - p_CUSTOM_CMAKE_PARAMETERS:
        default: !j2: '{{ custom_cmake_parameters | default("") }}'

    - parameter-separator/simple-colored(hidden):
        header: 'Options for Unittests'
        color: lavender
    - on-off-option(hidden):
        name: UT_ENABLED
        description: If ON, then UnitTests will run, otherwise skipped
        default: '{ut_enabled}'

    - parameter-separator/simple-colored(hidden):
        header: 'Options for Functional tests'
        color: lavender

    - on-off-option(hidden):
        name: FT_ENABLED
        subject: If ON, then FuncTests will run, otherwise skipped
        default: '{ft_enabled}'
    - p_FT_COMMIT_CHOICE_w_OPTION(hidden):
        default: '{ft_commit_choice_default}'
        option_default: '{ft_commit_choice_option_default}'
    - p_TEST_SELECT_EXPR(hidden):
        default: !j2: '{{ test_select_expr | default("") }}'
    - p_TEST_LIST(hidden):
        default: !j2: '{{ test_list | default("") }}'

    - parameter-separator/simple-colored(hidden):
        header: 'Options for Real cameras tests'
        color: lavender
    - on-off-option(hidden):
        name: RCT_ENABLED
        subject: If ON, then RealCameraTests will run, otherwise skipped
        default: '{rct_enabled}'
    - p_RCT_COMMIT_CHOICE_w_OPTION(hidden):
        default: '{rct_commit_choice_default}'
        option_default: '{rct_commit_choice_option_default}'
    - p_RCT_CAMERA_FILTER(hidden):
        name: RCT_CAMERA_FILTER
        default:  !j2: '{{ rct_camera_filter | default("*") }}'

    - parameter-separator/simple-colored(hidden):
        header: 'Options for Scalability tests'
        color: lavender
    - on-off-option(hidden):
        name: ST_ENABLED
        subject: If ON, then SacalbilityTests will run, otherwise skipped
        default: '{st_enabled}'
    - p_ST_SCENARIOS(hidden):
        default: !j2: '{{ st_scenarios | default("lws-50,lws-100,lws-150,lws-200,lws-250,lws-300,full-50,full-100,full-150,full-200") }}'
    - p_ST_COMMIT_CHOICE_w_OPTION(hidden):
        default: !j2: '{{ st_commit_choice_default | default("ST_LATEST") }}'
        option_default: !j2: '{{ st_commit_choice_option_default | default("") }}'
    - hidden:
        name: CANCEL_IN_FAV_OF_NEWER_BUILD
        default: !j2: '{{ cancel_in_fav_of_newer_build | default("false") }}'
    - hidden:
        name: RUN_KIND
        default: !j2: '{{run_kind | default(default_run_kind) }}'

- job-template:
    <<: *preset
    id: preset-tests-only
    parameters:

    - p_BRANCH(hidden):
        default: '{default_branch}'
    - p_BUILD_DESCRIPTION:
        default: !j2: '{{ build_description | default("Triggered manually") }}'

    - parameter-separator/simple-colored:
        header: 'Options for VMS'
        color: lavender
    - p_VMS_BUILD_CHOICE_w_OPTION:
        default: '{vms_build_choice_default}'
        option_default: '{vms_build_choice_option_default}'
    - p_PLATFORMS(hidden):
        allowed_choices: !j2: '{{ default_platforms | default("") }}'
        default: !j2: '{{ default_platforms | default("") }}'
    - p_CUSTOMIZATIONS(hidden):
        allowed_choices: !j2: '{{ default_customizations | default("") }}'
        default: !j2: '{{ default_customizations | default("") }}'

    - p_CLOUD_GROUP(hidden):
        default: test
    - p_BETA(hidden):
        default: !j2: '{{ beta | default("ON") }}'
    - p_CODE_SIGNING(hidden):
        default: 'OFF'
    - p_TRUSTED_TIMESTAMPING(hidden):
        default: 'OFF'
    - p_CUSTOM_CMAKE_PARAMETERS(hidden):
        default: !j2: '{{ custom_cmake_parameters | default("") }}'

    - parameter-separator/simple-colored(hidden):
        header: 'Options for Unittests'
        color: lavender
    - on-off-option(hidden):
        name: UT_ENABLED
        description: If ON, then UnitTests will run, otherwise skipped
        default: '{ut_enabled}'

    - parameter-separator/simple-colored:
        header: 'Options for Functional tests'
        color: lavender

    - on-off-option:
        name: FT_ENABLED
        subject: If ON, then FuncTests will run, otherwise skipped
        default: '{ft_enabled}'
    - p_FT_COMMIT_CHOICE_w_OPTION:
        default: '{ft_commit_choice_default}'
        option_default: '{ft_commit_choice_option_default}'
    - p_TEST_SELECT_EXPR:
        default: !j2: '{{ test_select_expr | default("") }}'
    - p_TEST_LIST:
        default: !j2: '{{ test_list | default("") }}'

    - parameter-separator/simple-colored:
        header: 'Options for Real cameras tests'
        color: lavender
    - on-off-option:
        name: RCT_ENABLED
        subject: If ON, then RealCameraTests will run, otherwise skipped
        default: '{rct_enabled}'
    - p_RCT_COMMIT_CHOICE_w_OPTION:
        default: '{rct_commit_choice_default}'
        option_default: '{rct_commit_choice_option_default}'
    - p_RCT_CAMERA_FILTER:
        name: RCT_CAMERA_FILTER
        default:  !j2: '{{ rct_camera_filter | default("*") }}'

    - parameter-separator/simple-colored:
        header: 'Options for Scalability tests'
        color: lavender
    - on-off-option:
        name: ST_ENABLED
        subject: If ON, then SacalbilityTests will run, otherwise skipped
        default: '{st_enabled}'
    - p_ST_SCENARIOS:
        default: !j2: '{{ st_scenarios | default("lws-50,lws-100,lws-150,lws-200,lws-250,lws-300,full-50,full-100,full-150,full-200") }}'
    - p_ST_COMMIT_CHOICE_w_OPTION:
        default: !j2: '{{ st_commit_choice_default | default("ST_LATEST") }}'
        option_default: !j2: '{{ st_commit_choice_option_default | default("") }}'
    - hidden:
        name: CANCEL_IN_FAV_OF_NEWER_BUILD
        default: !j2: '{{ cancel_in_fav_of_newer_build | default("false") }}'
    - hidden:
        name: RUN_KIND
        default: !j2: '{{run_kind | default(default_run_kind) }}'
