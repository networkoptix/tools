- job-template:
    name: '{pipeline}.helper.realcameratest-reporter'
    description: |
      <pre>
      ================================================================================
      Real camera test reporter
      ================================================================================

      JOB MAINTAINERS
        {job_maintainers}
        (notified by email on build failures)

      ONLY FAILED BUILDS MAY BE RETRIGGERED/RETRIED

      If build failed by infrastracture reasons anyone may try to retrigger uploading
      process.

      --------------------------------------------------------------------------------

      This job serves for parsing and uploading real camera test results into JunkShop
      service.

      To bypass pipeline descriptions from upstream builds there is BUILD_DESCRIPTION
      parameter. A string passed to BUILD_DESCRIPTION will be set as one of the lines
      of build description.

      --------------------------------------------------------------------------------
      </pre>

    node: reporter
    workspace: !j2: '{{ "__debug__" if __debug__ else "" }}{{ pipeline }}-rct-reporter'
    concurrent: false

    properties:
    - authorization-{pipeline}-system
    - priority-sorter:
        priority: !j2: '{{ pipeline_priority }}'
    - throttle:
        max-total: 5
        option: project
    - build-discarder:
        days-to-keep: 10
        num-to-keep: 500
        artifact-days-to-keep: 10
        artifact-num-to-keep: 500

    parameters:
    - p_BUILD_DESCRIPTION:
        default: ''
    - p_CLEAN_CLONE
    - p_BRANCH
    - p_NX_VMS_COMMIT
    - p_BUILD_IDENTITY
    - p_CUSTOMIZATION
    - p_PLATFORM
    - p_BUILD_STATUS
    - string:
        name: RCT_COMPONENT
    - p_PIPELINE(hidden):
        default: '{pipeline}'

    wrappers:
    - build-name:
        name: '#$BUILD_ID $BRANCH-$BUILD_IDENTITY@$NX_VMS_COMMIT'
    - timestamps
    - timeout:
        timeout: 15 # min
        fail: true
        type: absolute
    - workspace-cleanup
    - credentials-binding:
      - username-password:
          credential-id: junk_shop_db
          variable: JUNK_SHOP_DB_CREDENTIALS
    - pre-scm-buildstep:
        failOnError: true
        buildsteps:
        - mercurial/import-repo-if-missing:
            name: devtools
            branch: default
            platform: $PLATFORM
            customization: $CUSTOMIZATION
            pipeline: '{pipeline}'
            basedir: $WORKSPACE

    scm:
    - mercurial/local-mirror-no-changelog:
        name: devtools
        revision: 'default'

    builders:
    - inject:
        properties-content: |
          JUNKSHOP_URL={junkshop_base_url}/project/{junkshop_project_name}/$BRANCH/$BUILD_IDENTITY
          REPOSITORY_URL={artifacts_base_url}/$PIPELINE/$BRANCH/$BUILD_IDENTITY/$CUSTOMIZATION/$PLATFORM
    - decorators/set-custom-build-description

    - trigger-builds:
      - project: '{pipeline}.helper.pull-component'
        predefined-parameters: |
          REQUESTED_BY=$JOB_NAME-$BUILD_NUMBER
          BUILD_DESCRIPTION=$BUILD_DESCRIPTION
          BRANCH=$BRANCH
          BUILD_IDENTITY=$BUILD_IDENTITY
          CUSTOMIZATION=$CUSTOMIZATION
          PLATFORM=$PLATFORM
          SSH_USER=$USER
          LOCAL_PATH=$WORKSPACE/
          PLATFORM=$PLATFORM
          CUSTOMIZATION=$CUSTOMIZATION
          COMPONENTS=$RCT_COMPONENT/
          NODE_SSH_CONNECTION=$SSH_CONNECTION
        block: true
        block-thresholds:
          failure-threshold: FAILURE

    - shell: |
          #!/bin/bash
          set -ex
          if [ ! -d venv ]; then
            virtualenv --system-site-packages venv
          fi
          source venv/bin/activate
            pip install --upgrade pip setuptools wheel
            pip install --upgrade -r devtools/ci/junk_shop/requirements.txt

            export PYTHONPATH=$WORKSPACE/devtools/ci/junk_shop

            DB_CONFIG=$JUNK_SHOP_DB_CREDENTIALS@{junkshop_db_host}
            BUILD_PARAMETERS="\
          project={junkshop_project_name},\
          branch=$BRANCH,\
          build_num=$BUILD_IDENTITY,\
          platform=linux-x64,\
          customization=$CUSTOMIZATION"

            LAST_RUN_DIR=$(find $RCT_COMPONENT -maxdepth 1 -type d -name "run_*" | sort | tail -n 1)
            $WORKSPACE/devtools/ci/junk_shop/junk_shop/cameratest/save_results_main.py \
                "$DB_CONFIG" \
                "$BUILD_PARAMETERS" \
                "$LAST_RUN_DIR"

    publishers:
    - mercurial/rm-repo-if-broken
    - description-setter:
        description: >-
          <a href='$REPOSITORY_URL'> Artifacts </a>,
          <a href='$JUNKSHOP_URL'> Junkshop </a>
    - failure-email-helpers(maintainers):
        email-recipients: '{job_maintainers}'
