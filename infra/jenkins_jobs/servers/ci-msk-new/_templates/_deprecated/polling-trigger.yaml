- job-template:
    name: '{pipeline}.{version}.{project}.trigger.{preset}'
    id: polling-trigger
    description: |
      <pre>
      ================================================================================
      Build Trigger
      ================================================================================

      JOB MAINTAINERS
        {job_maintainers}
        (NOT notified by email on build failures)

      --------------------------------------------------------------------------------

      This job serves for starting bunch of builds associated with particular commit
      in nx_vms repository and also assigned build identity.

      By default (e.g. triggered automatically) it will build following installers
      {platforms}
      {customizations}

      There are some different triggers available.

      {detailed_job_description}

      See more details on build procedure in corresponding downstream "*.runner" job

      Note, that this job doesn't wait for downstream build completion.
      Find your build in crsp build queue

      --------------------------------------------------------------------------------
      </pre>
    # all build triggers will work under the same workspace as well as
    node: repo-write
    workspace: !j2: '{{ hg_local_cache_node_workspace }}'
    concurrent: false

    timer: ''  # no timed trigger by default
    poll_scm_timer: '* * * * *'
    clean_workspace: '' # false by default
    clean_build: '' # false by default
    default_build_description: ''
    build_webadmin: true
    build_installer: true
    run_functests: '' # false
    run_unittests: true
    run_realcameratests: '' # false

    ignore_functests: 'false' #
    # detailed_job_description required!

    properties:
    - authorization-{pipeline}-system
    - build-discarder:
        days-to-keep: 30
        num-to-keep: 100
        artifact-days-to-keep: 30
        artifact-num-to-keep: '{default_artifact_num_to_keep}'

    parameters:
    - p_BUILD_DESCRIPTION:
        default: '{default_build_description}'
    - parameter-separator/simple:
        header: Build parameters
    - p_CLEAN_WORKSPACE:
        default: '{clean_workspace}'
    - p_CLEAN_BUILD:
        default: '{clean_build}'
    - p_PLATFORMS:
        default: '{platforms}'
    - p_CUSTOMIZATIONS:
        default: '{customizations}'
    - p_BUILD_WEBADMIN:
        default: '{build_webadmin}'
    - p_BUILD_INSTALLER:
        default: '{build_installer}'
    - p_RUN_UNITTESTS:
        default: '{run_unittests}'
    - p_RUN_FUNCTESTS:
        default: '{run_functests}'
    - p_RUN_REALCAMERATESTS:
        default: '{run_realcameratests}'
    - administrative-section-separator
    - string:
        name: IGNORE_FUNCTESTS_COMMITS
        default: '{ignore_functests}'
    - p_BRANCH:
        default: '{default_branch}'
    - p_PIPELINE(hidden):
        default: '{pipeline}'

    triggers:
    - timed: "{timer}"
    - pollscm:
        cron: "{poll_scm_timer}"
        ignore-post-commit-hooks: True

    wrappers:
    - timestamps
    - timeout:
        # normally should complete in <1 min, but in case of clean clone this may not work
        # if there is no repo cloned yet, copy/clone it manually or change timeout
        timeout: 5 # min
        fail: true
        type: absolute

    scm:
    - mercurial/hdw-mx:
        project-name: nx_vms
        branch-name: $BRANCH

    builders:
    - inject:
        properties-content: |
          JUNKSHOP_URL={junkshop_base_url}/project/{junkshop_project_name}/$BRANCH/$BUILD_IDENTITY
    - decorators/set-custom-build-description

    - freeze-nx-vms-commit(local):
        commit-to-freeze: $MERCURIAL_REVISION_SHORT
        commit-varname: NX_VMS_COMMIT

    # load old commit sha
    - envvars/get-old-envvar:
        varname: NX_VMS_COMMIT
        which-build: last-successful
        optional: true

    # get new BUILD_IDENTITY
    - envvars/request-new-build-identity:
        pipeline: '{pipeline}'

    # Next, decide whether we should start runner ...
    # Jenkins does not support excluded-regions for hg and bazaar
    # That's why we manually check that if source files changed..
    - shell: |
        #!/bin/bash
        # Defaults to trigger
        echo "SHOULD_TRIGGER=true" > SHOULD_TRIGGER.envvar

    # TODO: remove copy-paste
    - shell: |
        #!/bin/bash
        set -ex

        # Note that if you want to add other conditions, e.g.
        # patch didn't affect 2 folders, you need to change this logic and calculate
        # exact files changed instead of lines in diff

        pushd nx_vms
          echo "Changes in nx_vms:"
          hg diff --stat -r "${{NX_VMS_COMMIT}}:${{NX_VMS_COMMIT_OLD}}" .
          total_changed="$(hg diff --stat -r "${{NX_VMS_COMMIT}}:${{NX_VMS_COMMIT_OLD}}" . | wc -l)"
          echo "total ${{total_changed}}"

          pushd func_tests
            echo "Changes in nx_vms/func_tests:"
            hg diff --stat -r "${{NX_VMS_COMMIT}}:${{NX_VMS_COMMIT_OLD}}" .
            func_tests_changed="$(hg diff --stat -r "${{NX_VMS_COMMIT}}:${{NX_VMS_COMMIT_OLD}}" . | wc -l)"
            echo "total ${{func_tests_changed}}"
          popd

        popd

        if [ "$IGNORE_FUNCTESTS_COMMITS" != "false" ] ; then
          if [ "${{total_changed}}" == "${{func_tests_changed}}" ] ; then
            echo "Ignore changeset because only func_tests are changed."
            echo "SHOULD_TRIGGER=false" > SHOULD_TRIGGER.envvar
          fi
        fi

    # finally inject
    - inject:
        properties-file: SHOULD_TRIGGER.envvar

    - conditional-step:
        condition-kind: strings-match
        condition-string1: '${{SHOULD_TRIGGER}}'
        condition-string2: 'false'
        steps:
        - description-setter:
            description: |
              RUNNER IS NOT TRIGGERED

    - conditional-step:
        condition-kind: strings-match
        condition-string1: '${{SHOULD_TRIGGER}}'
        condition-string2: 'true'
        steps:
        # We don't use multijob to hide dependency graph from trigger because graph
        # is too big and takes a while to be loaded
        # Anyway this graph is available in runner
        - trigger-builds:
          - project: '{pipeline}.{version}.{project}.runner'
            predefined-parameters: |
              REQUESTED_BY=$JOB_NAME-$BUILD_NUMBER
              UPSTREAM_JOB_NAME=$JOB_NAME
              BUILD_DESCRIPTION=$BUILD_DESCRIPTION
              BUILD_WEBADMIN=$BUILD_WEBADMIN
              BUILD_INSTALLER=$BUILD_INSTALLER
              RUN_UNITTESTS=$RUN_UNITTESTS
              RUN_FUNCTESTS=$RUN_FUNCTESTS
              RUN_REALCAMERATESTS=$RUN_REALCAMERATESTS
              PLATFORMS=$PLATFORMS
              CUSTOMIZATIONS=$CUSTOMIZATIONS
              BRANCH=$BRANCH
              CUSTOM_CMAKE_PARAMETERS=
              NX_VMS_COMMIT=$NX_VMS_COMMIT
              BUILD_IDENTITY=$BUILD_IDENTITY
              CLEAN_WORKSPACE=$CLEAN_WORKSPACE
              CLEAN_BUILD=$CLEAN_BUILD
            block: false # !! don't wait
            block-thresholds:
              failure-threshold: FAILURE

    publishers:
    - decorators/set-build-name:
        name: '#$BUILD_ID $BRANCH@$NX_VMS_COMMIT'
    - archive:
        artifacts: '*.envvar'
        allow-empty: 'false'
        fingerprint: true
    - failure-email-helpers(maintainers):
        email-recipients: '{job_maintainers}'
