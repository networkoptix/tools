- job:
    name: check_mac_vm
    description: |
      Ping mac virtual machine, reset it if failed
    node: master

    logrotate:
      daysToKeep: 14
      numToKeep: -1
      artifactDaysToKeep: -1
      artifactNumToKeep: -1
      
    triggers:
    - timed: H/10 * * * *

    wrappers:
    - timestamps

    builders:
    - shell: |
        MAC_VM_ADDR="10.0.0.79"
        #MAC_VM_ADDR="10.0.100.79"  # for testing
        NODE_NAME="mac-osx-10-13-2"

        ssh megatron id  # check if ssh itself works
        if [ ! -f jenkins-cli.jar ]; then
        	wget --no-verbose "$JENKINS_URL/jnlpJars/jenkins-cli.jar"
        fi

        if ! ssh megatron ping -c5 "$MAC_VM_ADDR"; then
        	echo
        	echo "MAC vm $MAC_VM_ADDR does not respond, resetting..."
            echo
            ssh megatron sudo /usr/local/bin/reset-mac-vm.sh
            echo
            #sleep 20
            #java -jar jenkins-cli.jar -s "$JENKINS_URL" connect-node "$NODE_NAME"
            exit 10
        fi
        echo "MAC vm is ok"
