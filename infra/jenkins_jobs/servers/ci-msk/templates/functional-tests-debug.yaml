# run functional tests manually - for debugging specific functional tests
# copy-paste from functional-tests.yaml, without trigger, with concurrent
#  and another default for upstream build number.

# Required template variables:
#   project-name
#   branch
#   platform
#   upstream-project
#   junk-shop-host
#   customization (default one)
#   cloud-group
#   binaries_url
#   job-timeout-minutes
#   test-timeout-hours

- job-template:
    name: '{project-name}-{branch}-{platform}-funtest-debug'
    node: funtest
    os: linux
    concurrent: true

    description: |
      Manually run functional tests for branch {branch} project {upstream-project}.

    copyartifact_filter: 'build_info.yaml, *-server-*-linux64*.deb, *-server-*-win64*.exe, unit_tests/**/appserver2_ut'

    parameters:
      - bool:
          name: CLEAN
          default: false
          description: Clean workspace before build
      - string:
          name: UPSTREAM_PROJECT
          default: '{upstream-project}/{branch}'
          description: name of upstream project to take artifacts to test from.
      - string:
          name: UPSTREAM_BUILD_NUMBER
          description: BUILD_NUMBER of upstream project to take artifacts to test from. By default use last unstable.
      - string:
          name: CUSTOMIZATION
          default: '{customization}'
          description: Customization to test.
      - bool:
          name: CLEAN_VM
          default: false
          description: Remove all existing test virtual machines before tests.
      - string:
          name: TEST_SELECT_EXPR
          default: 'not windows and not smb'
          description: >
            Test selection expression, parameter for pytest '-k' option.
            Empty means run all tests specified in TEST_LIST parameter below.
            Example: 'not windows and not smb' to exclude all windows and samba tests.
      - string:
          name: TEST_LIST
          default: ''
          description: Tests to run, space-delimited list. Empty means run all tests.

    wrappers:
    - build-name:
        name: '[${{BUILD_ID}}] $TEST_LIST'
    - timestamps
    - timeout:
        timeout: '{job-timeout-minutes}'
    - workspace-cleanup:
        check-parameter: CLEAN
    - credentials-binding:
      - username-password:
          credential-id: junk_shop_db
          variable: JUNK_SHOP_DB_CREDENTIALS
      - text:
          credential-id: service_email
          variable: AUTOTEST_EMAIL_PASSWORD

    scm:
    - hg-la:
        project-name: devtools
        branch-name: default
    - hg-la:
        project-name: nx_vms
        branch-name: '{branch}'

    builders:

      - shell: |
          set -xe
          rm -rf dist  # remove distributives from previous runs
      - conditional-step:
          condition-kind: not
          condition-operand:
            condition-kind: strings-match
            condition-string1: $UPSTREAM_BUILD_NUMBER
            condition-string2: ''
          on-evaluation-failure: dont-run
          steps:
            - copyartifact:
                project: $UPSTREAM_PROJECT
                which-build: specific-build
                build-number: $UPSTREAM_BUILD_NUMBER
                filter: '{copyartifact_filter}'
                target: dist
      - conditional-step:
          condition-kind: strings-match
          condition-string1: $UPSTREAM_BUILD_NUMBER
          condition-string2: ''
          on-evaluation-failure: dont-run
          steps:
            - copyartifact:
                project: $UPSTREAM_PROJECT
                which-build: last-successful
                stable: false  # it's ok if unit tests are failed
                filter: '{copyartifact_filter}'
                target: dist

      - init-venv-linux:
          requirements-files: >-
            devtools/ci/junk_shop/requirements.txt
            nx_vms/func_tests/requirements.txt

      - parse-build-info:
          branch: '{branch}'
          customization: $CUSTOMIZATION
          platform: '{platform}'

      - inject:
          properties-content: |
            JUNK_SHOP_CAPTURE_DB=$JUNK_SHOP_DB_CREDENTIALS@{junk-shop-host}
      - extended-bash:
          headers: ''
          script: |
            set -xe

            if [ -z "$SERVER_DEB_PATH" ]; then
              echo "Error: upstream job $UPSTREAM_PROJECT #$BUILD_NUM did not left mediaserver distributive for customization $CUSTOMIZATION"
              exit 1
            fi

            if [ -z "$APPSERVER2_UT_PATH" ]; then
              echo "Error: upstream job $UPSTREAM_PROJECT #$BUILD_NUM did not left appserver2_ut test for customization $CUSTOMIZATION"
              exit 1
            fi

            if [ ! -f "dist/$SERVER_DEB_PATH" ]; then
              echo "Error: mesiaserver deb file dist/$SERVER_DEB_PATH is missing - \
                    failed to retrieve artifact from $UPSTREAM_PROJECT/$UPSTREAM_BUILD_NUMBER"
              exit 1
            fi

            inject BIN_DIR "$WORKSPACE/funtest/bin"
            inject WORK_DIR "$WORKSPACE/funtest/work"
            mkdir -p "$BIN_DIR"
            rsync -av --delete {binaries_url} "$BIN_DIR/"

            if [ -f "dist/$APPSERVER2_UT_PATH" ]; then
              cp "dist/$APPSERVER2_UT_PATH" "$BIN_DIR/"
            else
              echo "Warning: $APPSERVER2_UT_PATH is missing"
            fi

      - run-functional-tests:
          project: '{project-name}'
          branch: '{branch}'
          build-num: $BUILD_NUM
          customization: $CUSTOMIZATION
          platform: '{platform}'
          cloud-group: '{cloud-group}'
          bin-dir: $BIN_DIR
          work-dir: $WORK_DIR
          mediaserver-dist-dir: "$WORKSPACE/dist"
          clean: $CLEAN_VM
          test-select-expr: "$TEST_SELECT_EXPR"
          test-list: "$TEST_LIST"
          test-timeout-hours: '{test-timeout-hours}'
