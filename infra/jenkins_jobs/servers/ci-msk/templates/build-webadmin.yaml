# build webadmin for ci or release projects

- job-template:
    name: '{project-name}-{branch}-webadmin'
    node: small-linux-{project-name}

    junk_shop_host: '10.0.2.101'

    description: |
      Build webadmin.

    parameters:
      - bool:
          name: CLEAN
          default: false
          description: remove workspace before build
      - bool:
          name: CLEAN_BUILD
          default: false
          description: make clean build
      - string:
          name: CUSTOMIZATION
          default: ''
          description: customization, if build only has single one
      - string:
          name: ROOT_BUILD_NUMBER
          description: jenkins BUILD_NUMBER for root build
      - bool:
          name: DO_BUILD
          default: true
          description: Do actually build webadmin, or just reuse results from previous build

    wrappers:
    - timestamps
    - timeout:
        timeout: 60
    - workspace-cleanup:
        check-parameter: CLEAN
    - credentials-binding:
      - username-password:
          credential-id: junk_shop_db
          variable: junk_shop_db_credentials

    scm:
    - hg-la:
        project-name: devtools
        branch-name: default
    - hg-la:
        project-name: nx_vms
        branch-name: '{branch}'

    builders:

      - shell: |
          #!/bin/bash
          set -xe

          if [[ "$CLEAN_BUILD" == "true" ]]; then
            rm -rf build
          fi

      - inject:
          properties-content: |
            DB_CONFIG=$junk_shop_db_credentials@{junk_shop_host}

      - init-venv:
          requirements-files: devtools/ci/junk_shop/requirements.txt

      # build webadmin
      - extended-bash:
          headers: ''
          script: |
            #!/bin/bash
            set -xe

            mkdir -p build
            pushd build
              if [ -f webadmin-build.log ]; then
                rm webadmin-build.log
              fi
              if [[ "$DO_BUILD" == "true" || ! -f server-external/bin/external.dat ]]; then
                $WORKSPACE/nx_vms/webadmin/build.sh  2>&1 | tee webadmin-build.log
                if [[ "${{PIPESTATUS[0]}}" == "0" ]]; then
                  OUTCOME=passed
                else
                  OUTCOME=failed
                fi
                DID_BUILD=true
              else
                DID_BUILD=false
              fi
            popd

            inject OUTCOME $OUTCOME
            inject DID_BUILD $DID_BUILD
      - conditional-step:
          condition-kind: shell
          condition-command: |
            #!/bin/bash -ex
            [ "$DID_BUILD" == "true" ]
          on-evaluation-failure: dont-run
          steps:
            - shell: echo 'saving output...'  # workaround for jjb bug
            - save-build-output:
                project-name: '{project-name}'
                branch: '{branch}'
                build-num: $ROOT_BUILD_NUMBER
                customization: $CUSTOMIZATION
                platform: webadmin
                output-file: build/webadmin-build.log
                outcome: $OUTCOME
      - store-to-nas:
          dir: build/server-external/bin
          files: external.dat
          nas-dir: '{project-name}-{branch}-$ROOT_BUILD_NUMBER/dev/web-admin'
          nas: '{nas}'
