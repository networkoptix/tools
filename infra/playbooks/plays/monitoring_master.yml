- name: Create linux (Ubuntu Xenial) prometheus master
  hosts: monitoring_master
  become: true
  become_method: sudo
  # We don't know status of guest, so if we try to gather facts (=connect),
  # but this guest is not created yet, we'll fail entire section.
  # That's why don't collect facts here.
  # All facts will be collected in libvirt_guest.
  gather_facts: no

  vars_files:
  - ../secrets/grafana.yml
  - ../secrets/prometheus_alertmanager.yml

  roles:
  - role: libvirt_guest
  - role: alphabet_common
    become: true
    when: libvirt_guest__state is undefined or libvirt_guest__current_state == 'running'
  - role: cloudalchemy.node-exporter
    become: true
    when: libvirt_guest__state is undefined or libvirt_guest__current_state == 'running'
  - role: cloudalchemy.prometheus
    become: true
    when: libvirt_guest__state is undefined or libvirt_guest__current_state == 'running'
  - role: cloudalchemy.grafana
    become: true
    when: libvirt_guest__state is undefined or libvirt_guest__current_state == 'running'
  - role: cloudalchemy.alertmanager
    become: true
    when: libvirt_guest__state is undefined or libvirt_guest__current_state == 'running'