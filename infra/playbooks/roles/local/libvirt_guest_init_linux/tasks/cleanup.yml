# It looks like cloud-init will try to activate installation one more time
# if reboot happens.
# So it would be safer to keep CD in tray.
#
# - name: Get Cloud init CD dev name
#   xml:
#     xmlstring: "{{ domain_xml }}"
#     xpath: '/domain/devices/disk[source/@file="{{ libvirt_guest__init_media_img }}"]/target'
#     content: attribute
#     attribute: dev
#   when: "libvirt_guest__state == 'running'"
#   failed_when: false
#   register: _cloud_init_cd_info
#   delegate_to: "{{ libvirt_host }}" # packages may be not installed on guest yet
#
# - name: Eject Cloud init CD
#   become: true
#   become_method: sudo
#   command: >-
#     virsh change-media {{ libvirt_guest__hostname }}
#     {{ _cloud_init_cd_info.matches[0].target.dev }} --eject
#   when:
#   - _cloud_init_cd_info.matches is defined
#   - _cloud_init_cd_info.matches[0].target.dev is defined
#   - >-
#     _cloud_init_cd_info.matches[0].target.tray is undefined or
#     _cloud_init_cd_info.matches[0].target.tray != 'open'
#   delegate_to: "{{ libvirt_host }}"

# For some reasons cloud-init doesn't add hostname to /etc/hosts
- name: Add guest's inventory name to /etc/hosts
  lineinfile:
    line: 127.0.0.1 {{ libvirt_guest__hostname }}
    path: /etc/hosts
  when: "libvirt_guest__state == 'running'"
