- name: Clean previous data
  file:
    path: "{{ item }}"
    state: absent
  with_items:
  - "{{ libvirt_guest__init_data_path }}"
  - "{{ libvirt_guest__init_media_img }}"
  delegate_to: "{{ libvirt_host }}"

- name: Create init data dir
  file:
    path: "{{ libvirt_guest__init_data_path }}"
    state: directory
  delegate_to: "{{ libvirt_host }}"

- name: Generate init configs
  template:
    src: "{{ item }}.j2"
    dest: "{{ libvirt_guest__init_data_path }}/{{ item }}"
  delegate_to: "{{ libvirt_host }}"
  with_items:
  - meta-data
  - user-data

- name: Generate guest init media
  command: >
    genisoimage -output {{ libvirt_guest__init_media_img }}
    -volid cidata -joliet -r user-data meta-data
  args:
    chdir: "{{ libvirt_guest__init_data_path }}/"
  delegate_to: "{{ libvirt_host }}"

- name: Prepare init disk specification
  set_fact:
    libvirt_guest__init_disk_spec:
      device: cdrom
      driver_type: raw
      source_file: "{{ libvirt_guest__init_media_img }}"
      target_bus: ide

- name: Finalize guest disks
  set_fact:
    libvirt_guest__disks_final: "{{ libvirt_guest__disks + [ libvirt_guest__init_disk_spec ] }}"
