- name: Prepare system images
  include_tasks: prepare_image.yml
  when: libvirt_guest__current_state == 'undefined'

- name: Get available options for os machine
  command: '/usr/bin/qemu-kvm -machine help'
  delegate_to: "{{ libvirt_host }}"
  register: available_machines
  when: libvirt_guest__current_state == 'undefined'
  changed_when: false
  check_mode: no

- name: Display all libvirt_guest__os_machine
  debug:
    var: libvirt_guest__os_machine

- name : Ensure os machine is available
  assert:
    that:
    - libvirt_guest__os_machine in available_machines.stdout

- name: "Define {{ libvirt_guest__hostname }}"
  virt:
    name: "{{ libvirt_guest__hostname }}"
    command: define
    xml: "{{ lookup('template', 'domain.xml.j2') }}"
    uri: "{{ libvirt_connection }}"
  delegate_to: "{{ libvirt_host }}"
  when: libvirt_guest__current_state == 'undefined'

- name: "Stop {{ libvirt_guest__hostname }}"
  virt:
    name: "{{ libvirt_guest__hostname }}"
    command: destroy
    uri: "{{ libvirt_connection }}"
  delegate_to: "{{ libvirt_host }}"
  when: libvirt_guest__current_state == 'running'

- name: Gather all facts about host and its VM
  include_tasks: get_facts.yml

- assert:
    that:
    - libvirt_guest__current_state == 'shutdown'
  when: not ansible_check_mode
