- name: Prepare system images
  include_tasks: prepare_image.yml
  when: libvirt_guest__current_state == 'undefined'

- name: "Define {{ libvirt_guest__hostname }}"
  virt:
    name: "{{ libvirt_guest__hostname }}"
    command: define
    xml: "{{ lookup('template', 'domain.xml.j2') }}"
  delegate_to: "{{ libvirt_host }}"
  when: libvirt_guest__current_state == 'undefined'

- name: "Stop {{ libvirt_guest__hostname }}"
  virt:
    name: "{{ libvirt_guest__hostname }}"
    command: destroy
  delegate_to: "{{ libvirt_host }}"
  when: libvirt_guest__current_state == 'running'

- name: Gather all facts about host and its VM
  include_tasks: get_facts.yml

- assert:
    that:
    - libvirt_guest__current_state == 'shutdown'
