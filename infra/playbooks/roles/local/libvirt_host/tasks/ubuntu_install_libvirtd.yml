---
- name: "Install {{ ansible_distribution }} libvirt packages"
  apt:
    name: "{{ item }}"
    state: present
  register: libvirt_install
  with_items:
  - qemu-kvm
  - libvirt0
  - virt-manager
  - bridge-utils
  - libguestfs-tools
  - lxc
  - lxctl

# TODO: Test and copy to debian procedures
# right now incorrect/unexpected restart will only affect VMs with nesting.
- name: Reboot the system when libvirt is installed
  become: yes
  shell: sleep 1 && /sbin/shutdown -r now "Ansible system package upgraded"
  when: libvirt_install.changed
  async: 1
  poll: 0

- name: Wait for connection
  become: false
  wait_for_connection:
    sleep: 1
    delay: 10
  when: libvirt_install.changed

# Ansible expects this symlink in one of its modules.
- name: "Fix missing /usr/bin/qemu-kvm link on {{ ansible_distribution }}"
  file:
    dest: /usr/bin/qemu-kvm
    src: /usr/bin/qemu-system-x86_64
    state: link
