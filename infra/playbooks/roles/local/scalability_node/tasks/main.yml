- name: Install packages
  become: yes
  become_method: sudo
  apt:
    pkg: "{{ item }}"
    state: present
    update_cache: yes
    cache_valid_time: 3600
  with_items:
  # common utils
  - gdb
  - net-tools  # netstat
  - curl
  # mediaserver deb requirements
  - libglib2.0-0
  - libsm6
  - libice6
  - libaudio2
  - libxrender1
  - cifs-utils
  - syslinux
  - zlib1g
  - debconf
  - python
  - psmisc
  - libsm6
  - libice6
  - libaudio2
  - libogg0
  - libxfixes3
  - libxrender1
  - libfontconfig1
  - libgl1-mesa-glx
  - cifs-utils
  - samba-common
  - libtalloc2
  - syslinux
  - iptables

- name: Set Kernel core pattern for system
  lineinfile:
    path: /etc/sysctl.conf
    create: yes
    state: present
    insertafter: EOF
    line: "kernel.core_pattern=%e.core.%t.%p"
  register: sysctl_conf

- name: Reload sysctl
  command: sysctl --system
  when: "{{ sysctl_conf.changed }}"

- name: "Add jenkins group {{ jenkins_group }}"
  group:
    name: "{{ jenkins_group }}"
    state: present

- name: "Add jenkins user {{ jenkins_user }}"
  user:
    name: "{{ jenkins_user }}"
    group: "{{ jenkins_group }}"
    home: "{{ jenkins_home }}"
    createhome: yes
    shell: /bin/bash

# Firewall
- name: Flush existing firewall rules
  iptables:
    flush: true

- name: Firewall rule - allow all loopback traffic
  iptables:
    action: append
    chain: INPUT
    in_interface: lo
    jump: ACCEPT
  register: allow_loopback_rule

- name: Firewall rule - allow established connections
  iptables:
    chain: INPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT
  become: true
  register: allow_established_rule

- name: Firewall rule - allow ICMP
  iptables:
    chain: INPUT
    jump: ACCEPT
    protocol: icmp
  register: allow_icmp_rule

- name: Firewall rule - allow port 22/SSH traffic
  iptables:
    chain: INPUT
    destination_port: 22
    jump: ACCEPT
    protocol: tcp
  become: true
  register: allow_ssh_rule

- name: Firewall rule - allow internal networks traffic
  iptables:
    chain: INPUT
    source: "{{ item }}"
    jump: ACCEPT
  become: yes
  with_items: "{{ allowable_ips }}"
  register: allow_network_rule

- name: Firewall rule - drop any traffic without rule
  iptables:
    chain: INPUT
    jump: DROP
  become: true
  register: drop_rule

- name: Save iptables rules
  command: iptables-save
  become: true
  when: >-
    allow_loopback_rule is changed or
    allow_established_rule is changed or
    allow_icmp_rule is changed or
    allow_ssh_rule is changed or
    allow_network_rule is changed or
    drop_rule is changed

- name: Set limits for user
  lineinfile:
    path: /etc/security/limits.conf
    create: yes
    state: present
    insertafter: EOF
    line: "{{ item }}"
  with_items:
  # maximum number of open files
  - "{{ jenkins_user }} soft nofile 1048576"
  - "{{ jenkins_user }} hard nofile 1048576"
  # limits the core file size (KB)
  - "{{ jenkins_user }} soft core unlimited"
  - "{{ jenkins_user }} hard core unlimited"
