- name: Install packages
  become: yes
  become_method: sudo
  apt:
    pkg: "{{ item }}"
    state: present
    update_cache: yes
    cache_valid_time: 3600
  with_items:
  # common utils
  - gdb
  - net-tools  # netstat
  - curl
  # mediaserver deb requirements
  - libglib2.0-0
  - libsm6
  - libice6
  - libaudio2
  - libxrender1
  - cifs-utils
  - syslinux
  - zlib1g
  - debconf
  - python
  - psmisc
  - libsm6
  - libice6
  - libaudio2
  - libogg0
  - libxfixes3
  - libxrender1
  - libfontconfig1
  - libgl1-mesa-glx
  - cifs-utils
  - samba-common
  - libtalloc2
  - syslinux

- name: Set Kernel core pattern for system
  lineinfile:
    path: /etc/sysctl.conf
    create: yes
    state: present
    insertafter: EOF
    line: "kernel.core_pattern=%e.core.%t.%p"
  register: sysctl_conf

- name: Reload sysctl
  command: sysctl --system
  when: "{{ sysctl_conf.changed }}"

- name: "Add jenkins group {{ jenkins_group }}"
  group:
    name: "{{ jenkins_group }}"
    state: present

- name: "Add jenkins user {{ jenkins_user }}"
  user:
    name: "{{ jenkins_user }}"
    group: "{{ jenkins_group }}"
    home: "{{ jenkins_home }}"
    createhome: yes
    shell: /bin/bash

- name: Set limits for user
  lineinfile:
    path: /etc/security/limits.conf
    create: yes
    state: present
    insertafter: EOF
    line: "{{ item }}"
  with_items:
  # maximum number of open files
  - "{{ jenkins_user }} soft nofile 1048576"
  - "{{ jenkins_user }} hard nofile 1048576"
  # limits the core file size (KB)
  - "{{ jenkins_user }} soft core unlimited"
  - "{{ jenkins_user }} hard core unlimited"
