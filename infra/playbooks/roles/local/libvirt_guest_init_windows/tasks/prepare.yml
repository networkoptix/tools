- name: Unmount media
  mount:
    path: "{{ libvirt_guest__init_data_path }}/floppy"
    state: absent
  delegate_to: "{{ libvirt_host }}"

- name: Clean previous data
  file:
    path: "{{ item }}"
    state: absent
  with_items:
  - "{{ libvirt_guest__init_data_path }}"
  - "{{ libvirt_guest__init_media_img }}"
  delegate_to: "{{ libvirt_host }}"

- name: Create init data dir
  file:
    path: "{{ libvirt_guest__init_data_path }}"
    state: directory
  delegate_to: "{{ libvirt_host }}"

- name: Create init media image
  become: true
  become_method: sudo
  command: '/sbin/mkfs.msdos -C {{ libvirt_guest__init_media_img }} 1440'
  delegate_to: "{{ libvirt_host }}"

- name: Create mount path
  file:
    path: "{{ libvirt_guest__init_data_path }}/floppy"
    state: directory
  delegate_to: "{{ libvirt_host }}"

- name: Mount init media
  mount:
    path: "{{ libvirt_guest__init_data_path }}/floppy"
    src: "{{ libvirt_guest__init_media_img }}"
    state: mounted
    opts: loop,rw
    fstype: auto
  delegate_to: "{{ libvirt_host }}"

- name: Generate init scripts using templates
  template:
    src: "floppy/{{ item }}.j2"
    dest: "{{ libvirt_guest__init_data_path }}/floppy/{{ item }}"
  delegate_to: "{{ libvirt_host }}"
  with_items:
  - add_default_keys.sh
  - setup_networks.ps1
  - change_hostname.ps1

- name: Copy init scripts w/o templating
  copy:
    src: files/floppy
    dest: "{{ libvirt_guest__init_data_path }}"
    directory_mode: yes
  delegate_to: "{{ libvirt_host }}"

- name: Unmount created init media
  mount:
    path: "{{ libvirt_guest__init_data_path }}/floppy"
    state: absent
  delegate_to: "{{ libvirt_host }}"

- name: Prepare init disk specification
  set_fact:
    libvirt_guest__init_disk_spec:
      device: floppy
      driver_type: raw
      source_file: "{{ libvirt_guest__init_media_img }}"
      target_bus: fdc

- name: Finalize guest disks
  set_fact:
    libvirt_guest__disks_final: "{{ libvirt_guest__disks + [ libvirt_guest__init_disk_spec ] }}"
