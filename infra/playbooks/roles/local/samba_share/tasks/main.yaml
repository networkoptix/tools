- name: Install CIFS and other required packages for mounting with apt
  become: true
  become_method: sudo
  apt:
    name: "{{ item }}"
    update_cache: yes
    state: installed
  when: ansible_os_family == 'Debian'
  with_items: "{{ apt_mount_packages }}"

- name: Install CIFS and other required packages for mounting with yum
  become: true
  become_method: sudo
  yum:
    name: "{{ item }}"
    update_cache: yes
    state: installed
  when: ansible_os_family == 'RedHat'
  with_items: "{{ yum_mount_packages }}"

- name: Create specific users to mount remote share
  become: true
  become_method: sudo
  include_role:
    name: ANXS.generic-users
  vars:
    genericusers_groups:
    - name: "{{ samba_group }}"
      gid: "{{ samba_gid }}"
      system: yes
    genericusers_users:
    - name: "{{ samba_user }}"
      uid: "{{ samba_uid }}"
      ssh_keys: []
      groups: ["{{ samba_group }}"]
      home: "/home/infra"
      system: yes

- name: Place Samba credentials file
  become: true
  become_method: sudo
  copy:
    content: |
      username={{ samba_mount_user }}
      password={{ samba_mount_pass }}
      domain={{ domain | upper }}
    dest: "{{ samba_home }}/.smbcredentials"
    owner: "{{ samba_user }}"
    mode: 0600

- name: Mount shared drive
  become: true
  become_method: sudo
  mount:
    fstype: cifs
    state: mounted
    path: "{{ samba_mount_path }}"
    opts: >-
      {{ [
        "credentials=" ~ samba_home ~ "/.smbcredentials",
        "gid=" ~ samba_gid,
        "uid=" ~ samba_uid,
        "dir_mode=" ~ dir_mode,
        "file_mode=" ~ file_mode
      ] | join(",") }}
    src: "{{ samba_share }}"
