- name: Clean previous data
  file:
    path: "{{ item }}"
    state: absent
  with_items:
  # TODO: should we prune it?
  - "{{ kvm_guest__system_image_file }}"
  delegate_to: "{{ kvm_host }}"
  when: kvm_guest__current_state == 'undefined'

- name: Copy guest disk image
  copy:
    src: "{{ kvm_guest__storage_pool_path }}/{{ kvm_guest__base_image }}"
    dest: "{{ kvm_guest__system_image_file }}"
    remote_src: yes
  delegate_to: "{{ kvm_host }}"
  when: >-
    kvm_guest_copy_on_write is undefined or
    kvm_guest_copy_on_write == False

- name: Create qcow2 guest disk image with backing file (copy-on-write)
  command: >-
    qemu-img create -f qcow2 -o
    backing_file={{ kvm_guest__storage_pool_path }}/{{ kvm_guest__base_image }}
    {{ kvm_guest__system_image_file }}
  args:
    creates: "{{ kvm_guest__system_image_file }}"
  delegate_to: "{{ kvm_host }}"
  when: >-
    kvm_guest_copy_on_write is defined and
    kvm_guest_copy_on_write == True

- name: Resize guest system disk image
  command: >-
    qemu-img resize {{ kvm_guest__system_image_file }}
    +{{ kvm_guest__extra_system_image_size_gb }}GB
  delegate_to: "{{ kvm_host }}"

- name: Prepare cloud-init media
  include_role:
    name: kvm_guest_cloud_init
    tasks_from: prepare
  when: kvm_guest__type == 'linux'

- name: Prepare win-init media
  include_role:
    name: kvm_guest_win_auto
    tasks_from: prepare
  when: kvm_guest__type == 'windows'
