- name: Define VM when it's undefined
  include_tasks: change_to_shutdown.yml
  when: kvm_guest__current_state == 'undefined'

- name: "Start {{ kvm_guest__hostname }}"
  virt:
    name: "{{ kvm_guest__hostname }}"
    state: running
  delegate_to: "{{ kvm_host }}"
  register: state
  when: >-
    kvm_guest__current_state == 'shutdown' or
    kvm_guest__current_state == 'paused'

- name: Pause before gathering facts
  pause:
    seconds: 5
  when: state.changed

- name: Gather all facts about host and its VM
  include_tasks: get_facts.yml
  when: state.changed

- assert:
    that:
    - kvm_guest__current_state == 'running'

- include_role:
    name: kvm_guest_cloud_init
    tasks_from: cleanup
  when: kvm_guest__type == 'linux'

- include_role:
    name: kvm_guest_win_auto
    tasks_from: cleanup
  when: kvm_guest__type == 'windows'
