- name: Download Base Image
  get_url:
    url: "{{ kvm_guest__base_image_url }}"
    dest: "{{ kvm_guest__base_image_path }}"

# TODO:
# Ubuntu is distributed in .img that is .qcow2 actually
# But other distribs probably require conversion
# - name: Convert Base Image
#   when: kvm_guest__distribution != "Ubuntu"

- name: Clean previous data
  file:
    path: "{{ kvm_guest__metainfo_path }}"
    state: absent
  with_items:
  - "{{ kvm_guest__metainfo_path }}"
  - "{{ kvm_guest__cloud_init_image_file }}"
  # TODO: should we prune it?
  - "{{ kvm_guest__system_image_file }}"

- name: Prepare guest disk image
  copy:
    src: /var/lib/libvirt/images/xenial-server-cloudimg-amd64-disk1.img
    dest: "{{ kvm_guest__system_image_file }}"
    remote_src: yes

- name: Resize guest disk image
  command: >
    qemu-img resize {{ kvm_guest__system_image_file }}
    +{{ kvm_guest__extra_system_image_size_gb }}GB

- name: Create cloud-init folder
  file:
    path: "{{ kvm_guest__metainfo_path }}"
    state: directory

- name: "Generate guest ci boot image: meta-data"
  template:
    src: meta-data.j2
    dest: "{{ kvm_guest__metainfo_path }}/meta-data"

- name: "Generate guest ci boot image: user-data"
  template:
    src: user-data.j2
    dest: "{{ kvm_guest__metainfo_path }}/user-data"

- name: "Generate guest ci boot image: gen ISO"
  command: >
    genisoimage -output {{ kvm_guest__cloud_init_image_file }}
    -volid cidata -joliet -r user-data meta-data
  args:
    chdir: "{{ kvm_guest__metainfo_path }}/"
  check_mode: no

- name: "Define {{ kvm_guest__hostname }}"
  virt:
    name: "{{ kvm_guest__hostname }}"
    command: define
    xml: "{{ lookup('template', 'domain.xml.j2') }}"
    # uri: qemu:///system

- include: "shut_off_to_{{ kvm_guest__state }}.yml"
