- name: "Check status of {{ kvm_guest__hostname }}"
  virt:
    name: "{{ kvm_guest__hostname }}"
    command: status
  register: domstate
  failed_when: false
  delegate_to: "{{ kvm_host }}"

- name: "Set fact kvm_guest__current_state for {{ kvm_guest__hostname }}"
  set_fact:
    kvm_guest__current_state: "{{ domstate.status }}"
  when: domstate.status is defined


- name: "Set fact kvm_guest__current_state for {{ kvm_guest__hostname }}"
  set_fact:
    kvm_guest__current_state: "undefined"
  when: domstate.status is undefined

- debug:
    msg: 'Current state is "{{ kvm_guest__current_state }}"'

- name: Wait for VM connection
  wait_for_connection:
    sleep: 1
    delay: 0
  when: "kvm_guest__current_state == 'running'"

- name: Gather facts if guest is running
  setup:
  when: "kvm_guest__current_state == 'running'"
  failed_when: false

- name: Get domain xml
  command: "virsh dumpxml {{ kvm_guest__hostname }}"
  register: dumpxml
  changed_when: false
  failed_when: false
  delegate_to: "{{ kvm_host }}"
  when: "kvm_guest__state != 'undefined'"

- name: Register domain.xml as fact
  set_fact:
    domain_xml: "{{ dumpxml.stdout }}"
  when: dumpxml is defined

# - name: Wait for {{ kvm_guest__hostname }} to become reachable


# - name: Gather facts if guest is running
#   setup:
#   when: "kvm_guest__current_state == 'running'"
#   failed_when: false
