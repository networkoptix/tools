- name: Setup libvirt on KVM hosts
  hosts: kvm_host
  become: true
  become_method: sudo

  roles:
  - role: alphabet_common
  - role: kvm_host

- name: Create guest VMs
  hosts: virtual
  become: true
  become_method: sudo
  # We don't know status of guest, so if we try to gather facts (=connect),
  # but this guest is not crated yet, we'll fail entire section.
  # That's why don't collect facts here.
  # All facts will be collected in kvm_guest.
  gather_facts: no

  roles:
  - role: kvm_guest
  - role: alphabet_common
    when: >-
      kvm_guest__state is undefined or kvm_guest__state == 'running'

- name: Setup guest
  hosts: build
  become: true
  become_method: sudo
  gather_facts: yes

  roles:
  - role: build_node
  - role: jenkins_slave

- name: Setup Deployment Console
  hosts: depcon
  become: true
  become_method: sudo
  gather_facts: yes

  vars_files:
  - secrets/depcon.yml

  roles:
  - role: nickjj.docker
  - role: depcon

- name: Setup Jenkins Master(s)
  hosts: jenkins

  roles:
  - role: geerlingguy.java
    become: true
    become_method: sudo
  - role: geerlingguy.jenkins
    become: true

- name: Setup mshevchenko custom build machine
  hosts: build
  become: true
  become_method: sudo
  gather_facts: yes

  vars:
    build_user: mshevchenko
    jenkins_user: mshevchenko
    jenkins_group: mshevchenko
    jenkins_home: /home/mshevchenko
    # added jenkins key: just in case...
    jenkins_authorized_keys:
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7t07Sl3znH+sPzBlhAgVWnpHLndsCGj0lTIJQo5YKWjlp1g4p6L0uFB4pgCM5zRyucF4PRmcAfYyAWKZ6N+Et4kB9BpdcpxGWX6evJ4RtA+iOED3SYZZoC/Y9rz+5RrH37tsgBFN1cW/CBuWq3xi0CEX/fD6r8sZy22fFJ9JPHFSDBsepWJPn8xJm0xNB05XYkbRoegMJxThf7XrvHgshhpNoiz9VVkje7jyGQC6ijAdMOHuR1p7RlLZpNyMCm9HKAq8L8uX5sKNBIpbc/GoQS9RGYI7iV9Cpq0F2ogKNYkT3cDC5L05cSqIwjTNYxZK9w+1YR22f/GZuMRu53C2R jenkins@megatron
    - ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAoGT65TU34jR3doZ/MN8fZaX8oskNLbrMslZj9lj8wuKXWX29ahgf602qjBty/p253Xp1ySwI57azwe7TWhDKlnxxMhz+zpVJqHOHFKCRBML2omvtDYr3aEW1IqGmznFSEDAxIoVswhM41DSv95j6xj/Apri763Duuz4UV7WxJtNJAxSqc8gsEZi5pPz80gASOH2nD3+C7yxe279vIe+9JAOiGzQg5hJJsapDt5q0VH1ix+MRebAuujrkGHCKsuUHI3bbQfOmyDkJPq90zxT2jS/SFHoPAApXwGgtqPc2BbSSfv8g177V1gA33oiEog03oFfwF9DQ5CQRIZ8Rie1aLQ== rsa-key-20151119

  roles:
  - role: build_node
  - role: jenkins_slave
  - role: custom_mshevchenko
