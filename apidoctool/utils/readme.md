# Apidoctool utils

## run_apidoctool.py

### General Information

This tool generates all necessary OpenAPI schemas for the sources within the specified directory.
To achieve this, the source directory is scanned for `apidoctool.properties` files and for each
file found, the process of generating the documentation (running `swagger-codegen` + `apidoctool`)
is initiated.

On the high level, it does the following things:

- Parse `conanfile.py` to extract the information about the Conan packages with programs used to
    generate the documentation (`swagger-codegen` and `apidoctool`).
- Download these Conan packages, or obtain the programs elsewhere.
- Scan the project source directory with all its subdirectories for the files named
    `apidoctool.properties` and generate OpenAPI schema for each file found using this file as a
    configuration for `apidoctool`, and `openapi_template.yaml` from the same directory as a
    template for the generated document.

### Defaults

To effectively use the default tool parameters, it is recommended to place the tool to the
`open/build_utils/run_apidoctool/` subdirectory of the project source directory. When run
without parameters, the tool uses the following defaults:

- The directory three level higher than the tool's directory is a root project directory.
- The directory <root_project_directory>-openapi_schemas is a directory where the generated
    documentation is placed.
- Newly created temporary directory to place downloaded Conan packages and other temporary files,
    which are deleted when the tool finishes.
- File `open/conanfile.py` from the project directory as a source of information about the versions
    of the programs used to generate the documentation.
- URL `https://artifactory.nxvms.dev/artifactory/api/conan/conan` as a Conan remote address.

### Usage Examples

#### Generate all OpenAPI schemas for the project

Assuming that the directory `~/develop/nx/` contains the project, run the following command:

```
~/develop/nx/open/build_utils/run_apidoctool/run_apidoctool.py
```

After the command finishes, the directory `~/develop/nx-openapi_schemas/` will contain all the
generated files.

#### Compare OpenAPI schemas generated for two different project states

Assuming that the directory `~/develop/nx1/` contains the first state, the directory
`~/develop/nx2/` contains the second state, run the following commands:

```
~/develop/nx1/open/build_utils/run_apidoctool/run_apidoctool.py --conan-dir /tmp/conan_packages
~/develop/nx2/open/build_utils/run_apidoctool/run_apidoctool.py --conan-dir /tmp/conan_packages
```

Once the commands complete, the directory `~/develop/nx1-openapi_schemas/` will house schemas for
`~/develop/nx1/`, while `~/develop/nx2-openapi_schemas/` will contain those for `~/develop/nx2`.
Additionally, the directory `/tmp/conan_packages/` will store downloaded Conan packages. If no
further executions of `run_apidoctool.py` are needed, this directory can be safely removed. Files
in `~/develop/nx1-openapi_schemas/` and `~/develop/nx2-openapi_schemas/` can then be compared using
any file comparison tool such as `diff` (although more specialized tools designed to compare
OpenAPI schemas are recommended).

#### Compare OpenAPI schemas generated by different apidoctool versions

Assuming that the directory `~/develop/nx/` contains the project, and you need to compare the
results generated by `apidoctool` used by the current state of the project and the results
generated by `apidoctool` from the Conan package determined by a Conan reference
`apidoctool/3.0@#11111111111111111111111111111111`, run the following commands:

```
~/develop/nx/open/build_utils/run_apidoctool/run_apidoctool.py --output-dir openapi_schemas1
~/develop/nx/open/build_utils/run_apidoctool/run_apidoctool.py \
    --output-dir openapi_schemas2 \
    --apidoctool-package-ref apidoctool/3.0@#11111111111111111111111111111111
```

After the commands finish, `~/develop/openapi_schemas1/` will contain schemas for the
`~/develop/nx/` directory, generated by `apidoctool` from the current project state. Similarly,
`~/develop/openapi_schemas2/` will hold schemas for the same directory but generated by
`apidoctool` from the specified Conan package revision. You can also utilize `apidoctool.jar`
accessible either via an HTTP URL or placed locally instead of using a Conan package. For accessing
it via a URL, use the `--apidoctool-jar-url` parameter, and for the local access employ the
`--apidoctool-jar` parameter.
